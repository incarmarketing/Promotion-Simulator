<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡œëª¨ì…˜ ìˆ˜ì… ì‹œë®¬ë ˆì´í„°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            /* Tailwind classes will handle background and text color, but keep for fallback/clarity */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        /* Custom scrollbar for dark mode, might not be as visible on light mode but still functional */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e0e0e0; } /* Lighter track for light background */
        ::-webkit-scrollbar-thumb { background: #a0a0a0; border-radius: 4px; } /* Lighter thumb */
        ::-webkit-scrollbar-thumb:hover { background: #707070; } /* Darker hover */

        #fileInput, #incomeFileInput, #loadStateInput { display: none; } /* Added #loadStateInput */
        .modal { transition: opacity 0.3s ease; }

        @media print {
            @page {
                size: A4 portrait;
                margin: 15mm;
            }
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .print-section {
                padding: 0;
                margin-bottom: 20px;
                border: none;
                page-break-after: always; /* Each scenario on a new page */
            }
            .print-section:last-child {
                page-break-after: auto;
            }
            .print-section h2, .print-section h3, .print-section p, .print-section span, .print-section div, .print-table th, .print-table td {
                color: #000000 !important;
            }
            .print-table {
                margin-top: 5px;
                width: 100%;
                border-collapse: collapse;
                font-size: 8pt;
            }
            .print-table th, .print-table td {
                border: 1px solid #ccc;
                padding: 4px 5px; /* Adjusted horizontal padding */
                text-align: left;
            }
            .print-table thead tr {
                background-color: #e2e8f0 !important;
                font-weight: bold;
            }
            .print-table .text-right { text-align: right; }
            .print-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
            .print-title {
                font-size: 1.1rem;
                font-weight: bold;
                margin-top: 0.1rem; /* Reduced top margin */
                margin-bottom: 0.2rem;
                border-bottom: 2px solid #4a5568;
                padding-bottom: 4px;
                background-color: #f1f5f9 !important;
                padding: 8px;
                display: flex;
                justify-content: space-between;
                align-items: flex-end;
            }
            .print-table .print-row-header {
                border-left-color: transparent;
                border-right-color: transparent;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 p-4 sm:p-6">

    <div id="main-content">
        <header class="flex items-center justify-between mb-6 w-full p-4">
            <img src="https://github.com/incarmarketing/bali-vote-project/blob/main/logo2.png?raw=true" alt="íšŒì‚¬ ë¡œê³ " class="h-16 object-contain" onerror="this.onerror=null;this.src='https://placehold.co/64x64/cccccc/000000?text=Logo';">
            <div class="flex flex-col items-center flex-grow">
                <h1 class="text-4xl sm:text-5xl font-bold text-gray-900">ğŸ–¥ï¸ í”„ë¡œëª¨ì…˜ ìˆ˜ì… ì‹œë®¬ë ˆì´í„°</h1>
                <p class="text-gray-600 mt-2">ì‹¤ì ê³¼ ìˆ˜ì…ì¡°ê±´ ë°ì´í„° ë§¤ì¹­ì„ í†µí•´ ì •í™•í•œ ì˜ˆìƒ ìˆ˜ì…ì„ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
            </div>
            <img src="https://github.com/incarmarketing/bali-vote-project/blob/main/logo3.png?raw=true" alt="ì½”ìŠ¤ë‹¥ ë¡œê³ " class="h-16 object-contain" onerror="this.onerror=null;this.src='https://placehold.co/64x64/cccccc/000000?text=KOSDAQ';">
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">1. ì‹¤ì  ë°ì´í„° ë° ì‹œë‚˜ë¦¬ì˜¤</h2>
                <label for="fileUploadButton" class="w-full inline-block text-center bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg cursor-pointer transition duration-300">
                    ğŸ“ ì‹¤ì  ì—‘ì…€ íŒŒì¼ ì„ íƒ
                </label>
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
                <div id="dataStatusDisplay" class="mt-4 w-full p-3 h-16 bg-gray-100 border border-gray-300 rounded-md flex items-center justify-center text-gray-600 text-center">
                    'ì‹¤ì ì—‘ì…€íŒŒì¼ì–‘ì‹'ì— ë§ì¶° ì‘ì„±ëœ íŒŒì¼ì„ ì—…ë¡œë“œ í•´ì£¼ì„¸ìš”.
                </div>
                <div id="scenariosContainer" class="grid md:grid-cols-3 gap-4 mt-4">
                    </div>
                <div class="mt-4 pt-4 border-t border-gray-300">
                    <label for="excludeDirectFamily" class="flex items-center cursor-pointer">
                        <input type="checkbox" id="excludeDirectFamily" class="form-checkbox h-5 w-5 text-cyan-600 bg-gray-100 border-gray-300 rounded focus:ring-cyan-500">
                        <span class="ml-3 text-gray-700">"ë‹¤ì´ë ‰íŠ¸" ì˜ì—…ê°€ì¡± ì œì™¸ (ë‹¬ì„±í˜„í™©)</span>
                    </label>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">2. ì˜ˆìƒ ìˆ˜ì… ê³„ì‚° ì¡°ê±´ (ê³µí†µ)</h2>
                <div class="flex items-center space-x-4 mb-4 text-gray-700">
                    <label class="flex items-center"><input type="radio" name="incomeSource" value="default" class="mr-2" checked>ê¸°ë³¸ê°’ ì‚¬ìš©</label>
                    <label class="flex items-center"><input type="radio" name="incomeSource" value="upload" class="mr-2">ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</label>
                </div>

                <div id="incomeUploadSection" class="hidden space-y-4">
                    <div class="flex space-x-4">
                        <button id="downloadTemplateBtn" class="flex-1 bg-gray-400 hover:bg-gray-500 text-gray-900 font-bold py-3 px-4 rounded-lg transition duration-300">ğŸ“‹ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
                        <label for="incomeFileInput" id="incomeFileUploadLabel" class="flex-1 inline-block text-center bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg cursor-pointer">ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ</label>
                        <input type="file" id="incomeFileInput" accept=".xlsx, .xls, .csv">
                    </div>
                </div>

                <div id="incomeFileStatusDisplay" class="mt-2 w-full p-3 h-16 bg-gray-100 border border-gray-300 rounded-md flex items-center justify-center text-gray-600 text-center text-sm">
                    ê¸°ë³¸ê°’ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.
                </div>
                
                <div class="mt-4">
                    <button id="editIncomeParamsBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                        âš™ï¸ í˜„ì¬ ìˆ˜ì… ì¡°ê±´ ë³´ê¸°/í¸ì§‘
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-gray-300">
                    <div class="input-item">
                        <label for="tripAttendanceRate" class="text-gray-700">ë‹¬ì„±ì(FA) ì°¸ì„ë¥ </label>
                        <div class="relative flex items-center">
                            <input type="number" id="tripAttendanceRate" class="w-full p-2 bg-gray-100 border border-gray-300 rounded-md text-right pr-10 text-gray-800" value="100">
                            <span class="absolute right-3 text-gray-500 pointer-events-none">(%)</span>
                        </div>
                    </div>
                    <div class="input-item">
                        <label for="tripCostPerPerson" class="text-gray-700">1ì¸ë‹¹ ì—¬í–‰ ê²½ë¹„</label>
                        <div class="relative flex items-center">
                            <input type="number" id="tripCostPerPerson" class="w-full p-2 bg-gray-100 border border-gray-300 rounded-md text-right pr-10 text-gray-800" value="2400000" step="100000">
                            <span class="absolute right-3 text-gray-500 pointer-events-none">(ì›)</span>
                        </div>
                    </div>
                    <div id="companionSummary" class="col-span-2 bg-gray-100 p-3 rounded-md text-center text-sm text-gray-600 hidden">
                        </div>
                    <div class="input-item">
                        <label for="attendingCompanions" class="text-gray-700">ë™ë°˜ ì°¸ì„ì¸ì›</label>
                        <div class="relative flex items-center">
                            <input type="number" id="attendingCompanions" class="w-full p-2 bg-gray-100 border border-gray-300 rounded-md text-right pr-10 text-gray-800" value="0" min="0">
                            <span class="absolute right-3 text-gray-500 pointer-events-none">(ëª…)</span>
                        </div>
                    </div>
                    <div class="input-item">
                        <label for="nonAttendeePayout" class="text-gray-700">ë¹„ì°¸ì„ì 1ì¸ë‹¹ ì§€ê¸‰ì•¡</label>
                        <div class="relative flex items-center">
                            <input type="number" id="nonAttendeePayout" class="w-full p-2 bg-gray-100 border border-gray-300 rounded-md text-right pr-10 text-gray-800" value="1400000" step="100000">
                            <span class="absolute right-3 text-gray-500 pointer-events-none">(ì›)</span>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-center space-x-4">
                    <button id="saveButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-105 shadow-lg">
                        ğŸ’¾ í˜„ì¬ ìƒíƒœ ì €ì¥
                    </button>
                    <button id="loadButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-105 shadow-lg">
                        ğŸ“‚ ì €ì¥ëœ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
                    </button>
                    <input type="file" id="loadStateInput" accept=".json">
                </div>
            </div>
        </div>
        
        <div class="mt-6">
            <button id="runButton" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-4 px-4 rounded-lg text-xl transition duration-300 transform hover:scale-105 shadow-lg disabled:bg-gray-300 disabled:text-gray-600 disabled:cursor-not-allowed" disabled>
                ğŸ“Š ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ ë° ìˆ˜ì… ê³„ì‚°
            </button>
            <button id="printButton" class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-300 disabled:bg-gray-300 disabled:text-gray-600 disabled:cursor-not-allowed" disabled>
                ğŸ–¨ï¸ ì „ì²´ ê²°ê³¼ ë³´ê³ ì„œ ì¸ì‡„
            </button>
        </div>

        <div id="resultsContainer" class="mt-6">
             <div id="status" class="mb-4 text-blue-600 text-center"></div>
             </div>
    </div>

    <div id="modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <h2 id="modalTitle" class="text-xl font-bold text-cyan-700">ìƒì„¸ ìˆ˜ì… ë‚´ì—­</h2>
                <button id="closeModal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="modalBody" class="p-6 overflow-y-auto text-gray-900"></div>
        </div>
    </div>

    <div id="incomeModal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-7xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <h2 class="text-xl font-bold text-cyan-700">ìˆ˜ì… ì¡°ê±´ í¸ì§‘ê¸°</h2>
                <button id="closeIncomeModal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="incomeModalBody" class="p-6 overflow-y-auto text-gray-900"></div>
            <div class="p-4 border-t border-gray-200 flex justify-end space-x-4">
                <button id="saveIncomeParamsBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">ë³€ê²½ì‚¬í•­ ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <div id="print-area" class="hidden"></div>

    <script id="worker" type="javascript/worker">
        // Web Worker for background processing
        self.onmessage = function(e) {
            try {
                const { jsonData, scenarios, incomeParams, commonParams, excludeDirectFamily } = e.data;

                if (!jsonData || jsonData.length === 0) {
                    self.postMessage({ error: "ì‹¤ì  ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤." });
                    return;
                }
                const headers = Object.keys(jsonData[0]);
                
                // Find column names dynamically
                const idCol = headers.find(h => h.includes('ì‚¬ì›ë²ˆí˜¸'));
                const nameCol = headers.find(h => h.includes('ë‹´ë‹¹ì') || h.includes('ì„±ëª…'));
                const dateCol = headers.find(h => h.includes('ê³„ì•½ì¼ì'));
                const performanceCol = headers.find(h => h.includes('ìµœì´ˆì¸ì •ì‹¤ì '));
                const companyCol = headers.find(h => h.includes('ë³´í—˜ì‚¬'));
                const typeCol = headers.find(h => h.includes('êµ¬ë¶„'));
                const recognitionRateCol = headers.find(h => h.includes('ISFì¸ì •ë¥ '));
                const salesFamilyCol = headers.find(h => h.includes('ì˜ì—…ê°€ì¡±'));

                if (!idCol || !dateCol || !performanceCol || !companyCol || !typeCol || !recognitionRateCol) {
                    self.postMessage({ error: "ì‹¤ì  íŒŒì¼ì— 'ì‚¬ì›ë²ˆí˜¸', 'ê³„ì•½ì¼ì', 'ìµœì´ˆì¸ì •ì‹¤ì ', 'ë³´í—˜ì‚¬', 'êµ¬ë¶„', 'ISFì¸ì •ë¥ ' ì—´ì´ ëª¨ë‘ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”." });
                    return;
                }

                // Create a map of company to its type (Life/Non-Life)
                const companyToTypeMap = {};
                jsonData.forEach(row => {
                    const company = String(row[companyCol] || '').trim();
                    if (!company) return;
                    const type = String(row[typeCol] || '');
                    if (!companyToTypeMap[company]) {
                        companyToTypeMap[company] = type.includes('ìƒë³´') || type.includes('ìƒëª…ë³´í—˜') ? 'ìƒëª…ë³´í—˜' : 'ì†í•´ë³´í—˜';
                    }
                });

                // Aggregate ALL performance data by employee. This will be used for INCOME calculation.
                const unfilteredAggregatedData = {};
                jsonData.forEach(row => {
                    const employeeId = row[idCol];
                    if (!employeeId) return;
                    const performanceRaw = row[performanceCol] || '0';
                    const performanceString = String(performanceRaw).replace(/[^0-9.-]/g, '');
                    let performance = parseFloat(performanceString);
                    if (isNaN(performance)) return;
                    const employeeName = nameCol ? row[nameCol] : '';
                    const contractDateRaw = row[dateCol] || '';
                    const cleanedDate = String(contractDateRaw).replace(/[^0-9]/g, '');
                    if (cleanedDate.length < 6) return; 
                    const month = cleanedDate.substring(4, 6);
                    if (!unfilteredAggregatedData[employeeId]) unfilteredAggregatedData[employeeId] = { name: employeeName, june: 0, july: 0, august: 0 };
                    if (month === '06') unfilteredAggregatedData[employeeId].june += performance;
                    else if (month === '07') unfilteredAggregatedData[employeeId].july += performance;
                    else if (month === '08') unfilteredAggregatedData[employeeId].august += performance;
                });

                // Filter data for ACHIEVEMENT DISPLAY based on the excludeDirectFamily flag
                const achievementData = excludeDirectFamily && salesFamilyCol 
                    ? jsonData.filter(row => !String(row[salesFamilyCol] || '').trim().startsWith('ë‹¤ì´ë ‰íŠ¸'))
                    : [...jsonData];
                
                // Aggregate filtered performance data for ACHIEVEMENT DISPLAY
                const aggregatedDataForDisplay = {};
                achievementData.forEach(row => {
                    const employeeId = row[idCol];
                    if (!employeeId) return;
                    const performanceRaw = row[performanceCol] || '0';
                    const performanceString = String(performanceRaw).replace(/[^0-9.-]/g, '');
                    let performance = parseFloat(performanceString);
                    if (isNaN(performance)) return;
                    const employeeName = nameCol ? row[nameCol] : '';
                    const contractDateRaw = row[dateCol] || '';
                    const cleanedDate = String(contractDateRaw).replace(/[^0-9]/g, '');
                    if (cleanedDate.length < 6) return; 
                    const month = cleanedDate.substring(4, 6);
                    if (!aggregatedDataForDisplay[employeeId]) aggregatedDataForDisplay[employeeId] = { name: employeeName, june: 0, july: 0, august: 0 };
                    if (month === '06') aggregatedDataForDisplay[employeeId].june += performance;
                    else if (month === '07') aggregatedDataForDisplay[employeeId].july += performance;
                    else if (month === '08') aggregatedDataForDisplay[employeeId].august += performance;
                });


                const results = [];
                // Tiers for achievement bonus calculation. This is a fixed business rule and not affected by the income condition file.
                const tiers = [
                    { name: '4êµ¬ê°„ ì´ˆê³¼(1000ë§Œ)', total: 10000000, cashBonus: 5000000, companions: 3 },
                    { name: '4êµ¬ê°„ ì´ˆê³¼(800ë§Œ)',  total: 8000000,  cashBonus: 3000000, companions: 3 },
                    { name: '4êµ¬ê°„ ì´ˆê³¼(600ë§Œ)',  total: 6000000,  cashBonus: 1000000, companions: 3 },
                    { name: '4êµ¬ê°„', monthly: 1600000, total: 5200000, cashBonus: 0, companions: 3 },
                    { name: '3êµ¬ê°„', monthly: 1200000, total: 3900000, cashBonus: 0, companions: 2 },
                    { name: '2êµ¬ê°„', monthly: 800000,  total: 2600000, cashBonus: 0, companions: 1 },
                    { name: '1êµ¬ê°„', monthly: 400000,  total: 1300000, cashBonus: 0, companions: 0 }
                ];

                for (const scenario of scenarios) {
                    if (isNaN(scenario.growthRate) || isNaN(scenario.monthlyTarget) || isNaN(scenario.totalTarget)) continue;

                    // SECTION 1: CALCULATE METRICS FOR UI DISPLAY (using filtered data)
                    let allEmployeesData = [];
                    let nonAchieverCounts = { '80ë§Œì  ì‹œìƒ': 0, '40ë§Œì  ì‹œìƒ': 0 };
                    let display_totalCompanions = 0;

                    for (const employeeId in aggregatedDataForDisplay) {
                        const empData = aggregatedDataForDisplay[employeeId];
                        const rate = 1 + scenario.growthRate / 100;
                        const projectedJune = empData.june * rate;
                        const projectedJuly = empData.july * rate;
                        const projectedAugust = empData.august * rate;
                        const totalProjected = projectedJune + projectedJuly + projectedAugust;
                        
                        const isConsecutiveAchieved = projectedJune >= scenario.monthlyTarget && projectedJuly >= scenario.monthlyTarget && projectedAugust >= scenario.monthlyTarget;
                        const isTotalAchieved = totalProjected >= scenario.totalTarget;
                        const isAchieved = isConsecutiveAchieved || isTotalAchieved;
                        
                        let achievementType = 'ë¯¸ë‹¬ì„±';
                        let achievementTier = 'í•´ë‹¹ì—†ìŒ';
                        let achieverCashBonus = 0;
                        let companionsForAchiever = 0;
                        let nonAchieverSpecialBonus = 0; // Initialize for each employee

                        if(isAchieved){
                            achievementType = isConsecutiveAchieved ? 'ì—°ì†ë‹¬ì„±' : 'í•©ì‚°ë‹¬ì„±';
                            for (const tier of tiers) {
                                const consecutiveMet = tier.monthly ? (projectedJune >= tier.monthly && projectedJuly >= tier.monthly && projectedAugust >= tier.monthly) : false;
                                const totalMet = tier.total ? (totalProjected >= tier.total) : false;
                                if (consecutiveMet || totalMet) {
                                    achievementTier = tier.name;
                                    achieverCashBonus = tier.cashBonus;
                                    companionsForAchiever = tier.companions;
                                    break; 
                                }
                            }
                            display_totalCompanions += companionsForAchiever;
                        } else {
                            if (totalProjected >= 800000 && totalProjected < 1300000) {
                                nonAchieverSpecialBonus = 800000;
                                nonAchieverCounts['80ë§Œì  ì‹œìƒ']++;
                            } else if (totalProjected >= 400000 && totalProjected < 800000) {
                                nonAchieverSpecialBonus = 400000;
                                nonAchieverCounts['40ë§Œì  ì‹œìƒ']++;
                            }
                        }

                        allEmployeesData.push({
                            'ì‚¬ì›ë²ˆí˜¸': employeeId, 'ë‹´ë‹¹ì': empData.name, 
                            '6ì›” ì˜ˆìƒì‹¤ì ': Math.round(projectedJune), '7ì›” ì˜ˆìƒì‹¤ì ': Math.round(projectedJuly), '8ì›” ì˜ˆìƒì‹¤ì ': Math.round(projectedAugust), 
                            '3ê°œì›” í•©ì‚°ì‹¤ì ': Math.round(totalProjected), 'ë‹¬ì„±ì—¬ë¶€': isAchieved ? 'ë‹¬ì„±' : 'ë¯¸ë‹¬ì„±', 
                            'ë‹¬ì„±ìœ í˜•': achievementType, 'ë‹¬ì„±êµ¬ê°„': achievementTier, 
                            'ë™ë°˜ì¸ì›': companionsForAchiever,
                            'ì¶”ê°€ì‹œìƒê¸ˆ(ë‹¬ì„±ì)': achieverCashBonus,
                            'ë¯¸ë‹¬ì„±ì íŠ¹ë³„ ì‹œìƒê¸ˆ': nonAchieverSpecialBonus
                        });
                    }

                    const achievers = allEmployeesData.filter(emp => emp['ë‹¬ì„±ì—¬ë¶€'] === 'ë‹¬ì„±');
                    const tierCounts = tiers.reduce((acc, tier) => ({ ...acc, [tier.name]: 0 }), {});
                    achievers.forEach(achiever => {
                        if (tierCounts.hasOwnProperty(achiever['ë‹¬ì„±êµ¬ê°„'])) tierCounts[achiever['ë‹¬ì„±êµ¬ê°„']]++;
                    });

                    // SECTION 2: CALCULATE METRICS FOR INCOME CALCULATION (using UNFILTERED data)
                    let income_totalTierCashBonus = 0;
                    let income_totalMonthlyNonAchieverBonus = 0;
                    let income_totalAchievers = 0;
                    let income_totalCompanions = 0;

                    for (const employeeId in unfilteredAggregatedData) {
                        const empData = unfilteredAggregatedData[employeeId];
                        const rate = 1 + scenario.growthRate / 100;
                        const projectedJune = empData.june * rate;
                        const projectedJuly = empData.july * rate;
                        const projectedAugust = empData.august * rate;
                        const totalProjected = projectedJune + projectedJuly + projectedAugust;
                        
                        const isConsecutiveAchieved = projectedJune >= scenario.monthlyTarget && projectedJuly >= scenario.monthlyTarget && projectedAugust >= scenario.monthlyTarget;
                        const isTotalAchieved = totalProjected >= scenario.totalTarget;
                        const isAchieved = isConsecutiveAchieved || isTotalAchieved;
                        
                        if (isAchieved) {
                            income_totalAchievers++;
                            for (const tier of tiers) {
                                const consecutiveMet = tier.monthly ? (projectedJune >= tier.monthly && projectedJuly >= tier.monthly && projectedAugust >= tier.monthly) : false;
                                const totalMet = tier.total ? (totalProjected >= tier.total) : false;
                                if (consecutiveMet || totalMet) {
                                    income_totalTierCashBonus += tier.cashBonus;
                                    income_totalCompanions += tier.companions;
                                    break; 
                                }
                            }
                        } else {
                            if (totalProjected >= 800000 && totalProjected < 1300000) {
                                income_totalMonthlyNonAchieverBonus += 800000;
                            } else if (totalProjected >= 400000 && totalProjected < 800000) {
                                income_totalMonthlyNonAchieverBonus += 400000;
                            }
                        }
                    }
                    
                    // SECTION 3: CALCULATE INCOME & EXPENSE
                    const nonLifeCompanyPerformances = {};
                    const employeeCompanyMonthlyPerf = {};
                    let totalLifeInsuranceRevenue = 0;
                    let lifeInsuranceRevenueDetails = {};
                    let monthlyPerformanceByCompany = {};

                    jsonData.forEach(row => {
                        const type = String(row[typeCol] || '');
                        let companyFromData = String(row[companyCol] || '').trim();
                        if (!companyFromData) return;

                        const performance = parseFloat(String(row[performanceCol] || '0').replace(/[^0-9.-]/g, ''));
                        if(isNaN(performance)) return;
                        
                        const growthRate = 1 + scenario.growthRate / 100;
                        const projectedPerformance = performance * growthRate;
                        
                        const cleanedDate = String(row[dateCol] || '').replace(/[^0-9]/g, '');
                        if(cleanedDate.length >= 6) {
                            const month = cleanedDate.substring(4, 6);
                            if (!monthlyPerformanceByCompany[companyFromData]) {
                                monthlyPerformanceByCompany[companyFromData] = { june: 0, july: 0, august: 0 };
                            }
                            if (month === '06') monthlyPerformanceByCompany[companyFromData].june += projectedPerformance;
                            else if (month === '07') monthlyPerformanceByCompany[companyFromData].july += projectedPerformance;
                            else if (month === '08') monthlyPerformanceByCompany[companyFromData].august += projectedPerformance;
                        }


                        if (type.includes('ì†ë³´') || type.includes('ì†í•´ë³´í—˜')) {
                            if (companyFromData === 'MGì†ë³´') return;
                            const employeeId = row[idCol];
                            if(employeeId && cleanedDate.length >= 6) {
                                if(!nonLifeCompanyPerformances[companyFromData]) nonLifeCompanyPerformances[companyFromData] = 0;
                                nonLifeCompanyPerformances[companyFromData] += performance;

                                if(!employeeCompanyMonthlyPerf[employeeId]) employeeCompanyMonthlyPerf[employeeId] = {};
                                if(!employeeCompanyMonthlyPerf[employeeId][companyFromData]) employeeCompanyMonthlyPerf[employeeId][companyFromData] = {june: 0, july: 0, august: 0};
                                const month = cleanedDate.substring(4, 6);
                                if(month === '06') employeeCompanyMonthlyPerf[employeeId][companyFromData].june += performance;
                                else if (month === '07') employeeCompanyMonthlyPerf[employeeId][companyFromData].july += performance;
                                else if (month === '08') employeeCompanyMonthlyPerf[employeeId][companyFromData].august += performance;
                            }
                        } else if (type.includes('ìƒë³´') || type.includes('ìƒëª…ë³´í—˜')) {
                            const recognitionRateFromData = parseFloat(row[recognitionRateCol]);
                            if (isNaN(recognitionRateFromData)) return;
                            
                            const lifeRule = incomeParams.life.find(rule => {
                                const ruleCompany = String(rule.company || '').trim();
                                const ruleRecognitionRate = parseFloat(rule.recognitionRate);
                                let isMatch = ruleCompany.toUpperCase() === companyFromData.toUpperCase();
                                if (!isMatch) {
                                    const upperCaseCompanyFromData = companyFromData.toUpperCase();
                                    if (ruleCompany === 'KBë¼ì´í”„ìƒëª…' && upperCaseCompanyFromData === 'KBë¼ì´í”„') isMatch = true;
                                    else if (ruleCompany === 'ë¯¸ë˜ì—ì…‹' && upperCaseCompanyFromData === 'ë¯¸ë˜ì—ì…‹ìƒëª…') isMatch = true;
                                }
                                return isMatch && ruleRecognitionRate === recognitionRateFromData;
                            });

                            if (lifeRule) {
                                const p = (val) => parseFloat(String(val).replace(/[^0-9.]/g, '')) || 0;
                                const retentionRate = p(lifeRule.retentionRate);
                                const lifeBonusNextMonth = projectedPerformance * p(lifeRule.nextMonth);
                                const lifeBonus13th = projectedPerformance * p(lifeRule.month13) * retentionRate;
                                const lifeRevenue = lifeBonusNextMonth + lifeBonus13th;
                                totalLifeInsuranceRevenue += lifeRevenue;

                                if (!lifeInsuranceRevenueDetails[companyFromData]) {
                                    lifeInsuranceRevenueDetails[companyFromData] = { bonusNextMonth: 0, bonus13th: 0, total: 0 };
                                }
                                lifeInsuranceRevenueDetails[companyFromData].bonusNextMonth += lifeBonusNextMonth;
                                lifeInsuranceRevenueDetails[companyFromData].bonus13th += lifeBonus13th;
                                lifeInsuranceRevenueDetails[companyFromData].total += lifeRevenue;
                            }
                        }
                    });

                    let totalIncomeDetails = { totalRevenue: 0, totalDeduction: 0, finalIncome: 0 };
                    let incomeDetailsByCompany = {};
                    let companyDeductionTotal = 0;
                    let totalIsfTravelAwardExpense = 0;

                    for(const company in nonLifeCompanyPerformances) {
                        const params = incomeParams.nonLife[company];
                        const expenseParams = incomeParams.expense[company];
                        if(!params || !expenseParams) continue;

                        const projectedPerformance = nonLifeCompanyPerformances[company] * (1 + scenario.growthRate / 100);
                        const p = (val) => parseFloat(String(val || '0').replace(/[^0-9.]/g, '')) || 0;
                        const retentionRate = p(params.retentionRate);
                        
                        const bonusNextMonth = projectedPerformance * p(params.coopBonusNextMonth);
                        const bonus13th = projectedPerformance * p(params.coopBonus13th) * retentionRate;
                        const bonusISF = projectedPerformance * p(params.isfAdd);
                        const totalRevenue = bonusNextMonth + bonus13th + bonusISF;

                        const dedCommission = projectedPerformance * p(expenseParams.commissionPreservation);
                        const dedOther = projectedPerformance * p(expenseParams.otherDeduction);
                        const dedLoss = projectedPerformance * p(expenseParams.lossPreservation);
                        const dedManagerTO = projectedPerformance * p(expenseParams.isfManagerTO);
                        const dedManagerSpecialNextMonth = projectedPerformance * p(expenseParams.managerSpecialNextMonth);
                        const dedManagerSpecial13th = projectedPerformance * p(expenseParams.managerSpecial13th) * retentionRate;
                        const dedIsfTravel = projectedPerformance * p(expenseParams.isfTravelBonus);
                        
                        let dedTravelExpense = 0;
                        for (const empId in employeeCompanyMonthlyPerf) {
                            if (employeeCompanyMonthlyPerf[empId][company]) {
                                const monthlyPerf = employeeCompanyMonthlyPerf[empId][company];
                                const rate = 1 + scenario.growthRate / 100;
                                const pJune = monthlyPerf.june * rate;
                                const pJuly = monthlyPerf.july * rate;
                                const pAugust = monthlyPerf.august * rate;

                                if (pJune >= 300000) dedTravelExpense += pJune * p(expenseParams.travelExpenseBonus30);
                                else if (pJune >= 200000) dedTravelExpense += pJune * p(expenseParams.travelExpenseBonus20);
                                if (pJuly >= 300000) dedTravelExpense += pJuly * p(expenseParams.travelExpenseBonus30);
                                else if (pJuly >= 200000) dedTravelExpense += pJuly * p(expenseParams.travelExpenseBonus20);
                                if (pAugust >= 300000) dedTravelExpense += pAugust * p(expenseParams.travelExpenseBonus30);
                                else if (pAugust >= 200000) dedTravelExpense += pAugust * p(expenseParams.travelExpenseBonus20);
                            }
                        }

                        const companyDeduction = dedCommission + dedOther + dedLoss + dedManagerTO + dedManagerSpecialNextMonth + dedManagerSpecial13th + dedTravelExpense;
                        
                        incomeDetailsByCompany[company] = { totalRevenue, companyDeduction, details: { bonusNextMonth, bonus13th, bonusISF, dedTravelExpense, dedCommission, dedOther, dedLoss, dedManagerTO, dedManagerSpecialNextMonth, dedManagerSpecial13th, dedIsfTravel } };
                        totalIncomeDetails.totalRevenue += totalRevenue;
                        companyDeductionTotal += companyDeduction;
                        totalIsfTravelAwardExpense += dedIsfTravel;
                    }

                    totalIncomeDetails.totalRevenue += totalLifeInsuranceRevenue;
                    totalIncomeDetails.lifeInsuranceRevenueDetails = lifeInsuranceRevenueDetails;

                    const attendanceRate = (commonParams.tripAttendanceRate || 100) / 100;
                    const nonAttendeeFACount = income_totalAchievers * (1 - attendanceRate);
                    const savedTripCostFA = nonAttendeeFACount * (commonParams.tripCostPerPerson || 0);
                    const nonAttendeePayoutTotalFA = nonAttendeeFACount * (commonParams.nonAttendeePayout || 0);
                    const netNonAttendeeFAIncome = savedTripCostFA - nonAttendeePayoutTotalFA;
                    totalIncomeDetails.totalRevenue += netNonAttendeeFAIncome;
                    totalIncomeDetails.netNonAttendeeFAIncome = netNonAttendeeFAIncome;

                    const attendingCompanionsInput = commonParams.attendingCompanions || 0;
                    const nonAttendingForThisScenario = Math.max(0, income_totalCompanions - attendingCompanionsInput);
                    const companionNetIncome = nonAttendingForThisScenario * (commonParams.tripCostPerPerson - commonParams.nonAttendeePayout);
                    totalIncomeDetails.totalRevenue += companionNetIncome;
                    totalIncomeDetails.companionNetIncome = companionNetIncome;
                    
                    totalIncomeDetails.totalDeduction = companyDeductionTotal + totalIsfTravelAwardExpense + income_totalTierCashBonus + income_totalMonthlyNonAchieverBonus;
                    totalIncomeDetails.finalIncome = totalIncomeDetails.totalRevenue - totalIncomeDetails.totalDeduction;
                    totalIncomeDetails.totalTierCashBonus = income_totalTierCashBonus;
                    totalIncomeDetails.totalMonthlyNonAchieverBonus = income_totalMonthlyNonAchieverBonus;

                    let performanceSummary = { life: 0, nonLife: 0, byCompany: {} };
                    jsonData.forEach(row => {
                        const performance = parseFloat(String(row[performanceCol] || '0').replace(/[^0-9.-]/g, ''));
                        if(isNaN(performance)) return;
                        const projectedPerformance = performance * (1 + scenario.growthRate / 100);
                        const company = String(row[companyCol] || '').trim();
                        const type = String(row[typeCol] || '');
                        if(company) {
                            if(!performanceSummary.byCompany[company]) performanceSummary.byCompany[company] = 0;
                            performanceSummary.byCompany[company] += projectedPerformance;
                        }
                        if (type.includes('ìƒë³´') || type.includes('ìƒëª…ë³´í—˜')) {
                            performanceSummary.life += projectedPerformance;
                        } else if (type.includes('ì†ë³´') || type.includes('ì†í•´ë³´í—˜')) {
                            performanceSummary.nonLife += projectedPerformance;
                        }
                    });

                    // SECTION 4: ASSEMBLE FINAL RESULT OBJECT
                    results.push({
                        id: scenario.id,
                        achievers, 
                        allEmployeesData, 
                        performanceSummary, 
                        tierCounts, 
                        nonAchieverCounts,
                        incomeDetails: totalIncomeDetails, 
                        incomeDetailsByCompany, 
                        totalCompanions: display_totalCompanions, 
                        monthlyPerformanceByCompany,
                        companyToTypeMap
                    });
                }
                self.postMessage({ results });
            } catch (error) {
                self.postMessage({ error: `ì›Œì»¤ ì˜¤ë¥˜: ${error.message}\n${error.stack}` });
            }
        };
    </script>

    <script>
        // Main Page Script
        const scenariosContainer = document.getElementById('scenariosContainer');
        const runButton = document.getElementById('runButton');
        const resultsContainer = document.getElementById('resultsContainer');
        const statusDiv = document.getElementById('status');
        const fileInput = document.getElementById('fileInput');
        const fileUploadButton = document.querySelector('label[for="fileUploadButton"]');
        const dataStatusDisplay = document.getElementById('dataStatusDisplay');
        const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
        const incomeFileInput = document.getElementById('incomeFileInput');
        const incomeFileUploadLabel = document.getElementById('incomeFileUploadLabel');
        const incomeFileStatusDisplay = document.getElementById('incomeFileStatusDisplay');
        const incomeUploadSection = document.getElementById('incomeUploadSection');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const closeModalBtn = document.getElementById('closeModal');
        const companionSummaryDiv = document.getElementById('companionSummary');
        const printButton = document.getElementById('printButton');
        const editIncomeParamsBtn = document.getElementById('editIncomeParamsBtn');
        const incomeModal = document.getElementById('incomeModal');
        const closeIncomeModalBtn = document.getElementById('closeIncomeModal');
        const saveIncomeParamsBtn = document.getElementById('saveIncomeParamsBtn');
        const incomeModalBody = document.getElementById('incomeModalBody');
        // New save/load buttons
        const saveButton = document.getElementById('saveButton');
        const loadButton = document.getElementById('loadButton');
        const loadStateInput = document.getElementById('loadStateInput'); // New input for loading state
        
        let worker;
        let loadedJsonData = null;
        let loadedIncomeParams = null;
        let scenarioResultsData = {};

        // Default income parameters are based on the user's provided 'ìˆ˜ì…ì§€ì¶œ_ì¡°ê±´_ì–‘ì‹.xlsx' file.
        // This data is embedded to ensure it's always available on load.
        const defaultIncomeParams = {
            nonLife: {
                'ë©”ë¦¬ì¸ í™”ì¬': { retentionRate: 0.85, coopBonusNextMonth: 1, coopBonus13th: 7.57, isfAdd: 0.5 },
                'í•œí™”ì†ë³´': { retentionRate: 0.85, coopBonusNextMonth: 0, coopBonus13th: 7.5, isfAdd: 0.5 },
                'DBì†ë³´': { retentionRate: 0.85, coopBonusNextMonth: 0.5, coopBonus13th: 6.5, isfAdd: 0 },
                'ë¡¯ë°ì†ë³´': { retentionRate: 0.85, coopBonusNextMonth: 0, coopBonus13th: 6.5, isfAdd: 1 },
                'í¥êµ­í™”ì¬': { retentionRate: 0.85, coopBonusNextMonth: 0, coopBonus13th: 6.5, isfAdd: 0.5 },
                'ë†í˜‘ì†ë³´': { retentionRate: 0.85, coopBonusNextMonth: 0, coopBonus13th: 6.5, isfAdd: 0.5 },
                'ì‚¼ì„±í™”ì¬': { retentionRate: 0.85, coopBonusNextMonth: 2, coopBonus13th: 4.5, isfAdd: 0.5 },
                'í˜„ëŒ€í•´ìƒ': { retentionRate: 0.85, coopBonusNextMonth: 0.5, coopBonus13th: 5.5, isfAdd: 0.8 },
                'KBì†ë³´': { retentionRate: 0.85, coopBonusNextMonth: 0.5, coopBonus13th: 6, isfAdd: 0 },
                'í•˜ë‚˜ì†ë³´': { retentionRate: 0.85, coopBonusNextMonth: 0, coopBonus13th: 5.5, isfAdd: 0.5 },
                'AIGì†ë³´': { retentionRate: 0.85, coopBonusNextMonth: 0, coopBonus13th: 5.5, isfAdd: 0 }
            },
            life: [
                { company: 'ABLìƒëª…', recognitionRate: 50, retentionRate: 0.95, nextMonth: 0, month13: 1 },
                { company: 'ABLìƒëª…', recognitionRate: 100, retentionRate: 0.95, nextMonth: 0, month13: 2 },
                { company: 'DBìƒëª…', recognitionRate: 110, retentionRate: 0.95, nextMonth: 0, month13: 2.5 },
                { company: 'DBìƒëª…', recognitionRate: 100, retentionRate: 0.95, nextMonth: 0, month13: 2 },
                { company: 'DBìƒëª…', recognitionRate: 50, retentionRate: 0.95, nextMonth: 0, month13: 1 },
                { company: 'IMë¼ì´í”„', recognitionRate: 50, retentionRate: 0.95, nextMonth: 0, month13: 1 },
                { company: 'KBë¼ì´í”„ìƒëª…', recognitionRate: 75, retentionRate: 0.95, nextMonth: 0, month13: 1.5 },
                { company: 'KDBìƒëª…', recognitionRate: 50, retentionRate: 0.95, nextMonth: 0, month13: 1 },
                { company: 'NHë†í˜‘ìƒëª…', recognitionRate: 50, retentionRate: 0.95, nextMonth: 0, month13: 1 },
                { company: 'ë™ì–‘ìƒëª…', recognitionRate: 100, retentionRate: 0.95, nextMonth: 0, month13: 2 },
                { company: 'ë¼ì´ë‚˜ìƒëª…', recognitionRate: 50, retentionRate: 0.95, nextMonth: 0, month13: 1 },
                { company: 'ë¼ì´ë‚˜ìƒëª…', recognitionRate: 100, retentionRate: 0.95, nextMonth: 0, month13: 2 },
                { company: 'ë©”íŠ¸ë¼ì´í”„', recognitionRate: 100, retentionRate: 0.95, nextMonth: 0, month13: 2 },
                { company: 'ë©”íŠ¸ë¼ì´í”„', recognitionRate: 50, retentionRate: 0.95, nextMonth: 1, month13: 0 },
                { company: 'ë¯¸ë˜ì—ì…‹', recognitionRate: 100, retentionRate: 0.95, nextMonth: 0, month13: 2 },
                { company: 'ì‚¼ì„±ìƒëª…', recognitionRate: 100, retentionRate: 0.95, nextMonth: 0, month13: 2 },
                { company: 'ì‹ í•œë¼ì´í”„', recognitionRate: 50, retentionRate: 0.95, nextMonth: 0, month13: 1 },
                { company: 'ì²˜ë¸Œë¼ì´í”„', recognitionRate: 100, retentionRate: 0.95, nextMonth: 0, month13: 2 },
                { company: 'í‘¸ë³¸í˜„ëŒ€ìƒëª…', recognitionRate: 100, retentionRate: 0.95, nextMonth: 1, month13: 1 },
                { company: 'í‘¸ë³¸í˜„ëŒ€ìƒëª…', recognitionRate: 50, retentionRate: 0.95, nextMonth: 1, month13: 0 },
                { company: 'í•œí™”ìƒëª…', recognitionRate: 50, retentionRate: 0.95, nextMonth: 0, month13: 1 },
                { company: 'í¥êµ­ìƒëª…', recognitionRate: 100, retentionRate: 0.95, nextMonth: 0, month13: 2 },
            ],
            expense: {
                'ë©”ë¦¬ì¸ í™”ì¬': { commissionPreservation: 1, otherDeduction: 0.97, lossPreservation: 0.5, isfTravelBonus: 2.2, travelExpenseBonus20: 1.5, travelExpenseBonus30: 2, isfManagerTO: 0.2, managerSpecialNextMonth: 0.5, managerSpecial13th: 0.5 },
                'í•œí™”ì†ë³´': { commissionPreservation: 1, otherDeduction: 0, lossPreservation: 0.5, isfTravelBonus: 2.2, travelExpenseBonus20: 1, travelExpenseBonus30: 1.5, isfManagerTO: 0.2, managerSpecialNextMonth: 0.5, managerSpecial13th: 0.6 },
                'DBì†ë³´': { commissionPreservation: 1, otherDeduction: 0, lossPreservation: 0.5, isfTravelBonus: 2.2, travelExpenseBonus20: 0.5, travelExpenseBonus30: 1, isfManagerTO: 0.2, managerSpecialNextMonth: 0.5, managerSpecial13th: 0.3 },
                'ë¡¯ë°ì†ë³´': { commissionPreservation: 1, otherDeduction: 0, lossPreservation: 0.5, isfTravelBonus: 2, travelExpenseBonus20: 1.5, travelExpenseBonus30: 2, isfManagerTO: 0.2, managerSpecialNextMonth: 0.4, managerSpecial13th: 0.6 },
                'í¥êµ­í™”ì¬': { commissionPreservation: 1, otherDeduction: 0, lossPreservation: 0.5, isfTravelBonus: 2, travelExpenseBonus20: 1, travelExpenseBonus30: 1.5, isfManagerTO: 0.2, managerSpecialNextMonth: 0.4, managerSpecial13th: 0.6 },
                'ë†í˜‘ì†ë³´': { commissionPreservation: 1, otherDeduction: 0, lossPreservation: 0.5, isfTravelBonus: 2, travelExpenseBonus20: 1.5, travelExpenseBonus30: 1.5, isfManagerTO: 0.2, managerSpecialNextMonth: 0.4, managerSpecial13th: 0.6 },
                'ì‚¼ì„±í™”ì¬': { commissionPreservation: 1, otherDeduction: 0, lossPreservation: 0.5, isfTravelBonus: 2, travelExpenseBonus20: 0.5, travelExpenseBonus30: 1.5, isfManagerTO: 0.2, managerSpecialNextMonth: 0.4, managerSpecial13th: 0.6 },
                'í˜„ëŒ€í•´ìƒ': { commissionPreservation: 1, otherDeduction: 0, lossPreservation: 0.5, isfTravelBonus: 2, travelExpenseBonus20: 1, travelExpenseBonus30: 1.5, isfManagerTO: 0.2, managerSpecialNextMonth: 0.4, managerSpecial13th: 0.6 },
                'KBì†ë³´': { commissionPreservation: 1, otherDeduction: 0, lossPreservation: 0.5, isfTravelBonus: 2, travelExpenseBonus20: 1, travelExpenseBonus30: 1.5, isfManagerTO: 0.2, managerSpecialNextMonth: 0.4, managerSpecial13th: 0.6 },
                'í•˜ë‚˜ì†ë³´': { commissionPreservation: 1, otherDeduction: 0, lossPreservation: 0.5, isfTravelBonus: 2, travelExpenseBonus20: 1, travelExpenseBonus30: 1.5, isfManagerTO: 0.2, managerSpecialNextMonth: 0.4, managerSpecial13th: 0.6 },
                'AIGì†ë³´': { commissionPreservation: 1, otherDeduction: 0, lossPreservation: 0.5, isfTravelBonus: 2, travelExpenseBonus20: 1, travelExpenseBonus30: 1.5, isfManagerTO: 0.2, managerSpecialNextMonth: 0.4, managerSpecial13th: 0.6 }
            }
        };
        
        // Headers for template download, matching the user's file exactly.
        const templateHeaders = {
            nonLife: ['ë³´í—˜ì‚¬', '13íšŒì°¨ ìœ ì§€ìœ¨', 'ìƒìƒì‹œìƒ (ìµì›”)', 'ìƒìƒì‹œìƒ (13íšŒ_ìœ ì§€)', 'ISF ì¶”ê°€'],
            life: ['ë³´í—˜ì‚¬ëª…', 'ISFì¸ì •ë¥ ', '13íšŒì°¨ ìœ ì§€ìœ¨', 'ì‹œìƒì¬ì›\n(ìµì›”)', 'ì‹œìƒì¬ì›\n(13íšŒ)'],
            expense: ['ë³´í—˜ì‚¬', 'ìˆ˜ìˆ˜ë£Œì„ ì§€ê¸‰ ë³´ì¡´', 'ê¸°íƒ€ ê³µì œ', 'ì†ì‹¤ë³´ì „', 'ISF ì—¬í–‰ì‹œìƒ', 'ì—¬í–‰ê²½ë¹„ ì¶”ê°€ì‹œìƒ(ê°ì›”,ê°ë³´í—˜ì‚¬,ê°ì‚¬ì›ë²ˆí˜¸ë³„ 20ë§Œ ì´ìƒ_30ë§Œì› ë¯¸ë§Œ ì‹œ)', 'ì—¬í–‰ê²½ë¹„ ì¶”ê°€ì‹œìƒ(ê°ì›”,ê°ë³´í—˜ì‚¬,ê°ì‚¬ì›ë²ˆí˜¸ë³„ 30ë§Œì› ì´ìƒ ì‹œ)', 'ISF ê´€ë¦¬ì T/O', 'ìµì›”_ê´€ë¦¬ìíŠ¹ë³„ì‹œì±…', '13íšŒ_ê´€ë¦¬ìíŠ¹ë³„ì‹œì±…']
        };

        // Function to check if the run button should be enabled
        function checkRunButtonStatus() {
            runButton.disabled = !(loadedJsonData && loadedIncomeParams);
        }

        // Initial setup on page load
        window.addEventListener('load', () => {
            attachEventListeners();
            createScenarioInputs();
            loadedIncomeParams = JSON.parse(JSON.stringify(defaultIncomeParams)); // Use a deep copy
            checkRunButtonStatus();
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            dataStatusDisplay.textContent = 'ğŸ”„ íŒŒì¼ ì½ëŠ” ì¤‘...';
            runButton.disabled = true;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true, dateNF:'YYYY-MM-DD' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    loadedJsonData = XLSX.utils.sheet_to_json(worksheet); 
                    dataStatusDisplay.innerHTML = `<span class="text-green-600 font-bold">âœ… ì´ ${loadedJsonData.length.toLocaleString()} ê±´ì˜ ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.</span>`;
                    checkRunButtonStatus();
                } catch (error) {
                    dataStatusDisplay.innerHTML = `<span class="text-red-600 font-bold">âš ï¸ íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: ${error.message}</span>`;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function handleIncomeFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            incomeFileStatusDisplay.textContent = 'ğŸ”„ íŒŒì¼ ì½ëŠ” ì¤‘...';
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const nonLifeSheet = workbook.Sheets['ì†ë³´ìˆ˜ì…'];
                    const lifeSheet = workbook.Sheets['ìƒë³´ìˆ˜ì…'];
                    const expenseSheet = workbook.Sheets['ì§€ì¶œ'];
                    if (!nonLifeSheet || !lifeSheet || !expenseSheet) { throw new Error("ì—‘ì…€ íŒŒì¼ì— 'ì†ë³´ìˆ˜ì…', 'ìƒë³´ìˆ˜ì…', 'ì§€ì¶œ' ì‹œíŠ¸ê°€ ëª¨ë‘ í•„ìš”í•©ë‹ˆë‹¤."); }
                    const nonLifeJson = XLSX.utils.sheet_to_json(nonLifeSheet, {header:1});
                    const lifeJson = XLSX.utils.sheet_to_json(lifeSheet, {header:1});
                    const expenseJson = XLSX.utils.sheet_to_json(expenseSheet, {header:1});
                    const params = { nonLife: {}, life: [], expense: {} };
                    nonLifeJson.slice(1).forEach(row => { if(row[0]) params.nonLife[row[0]] = { retentionRate: row[1], coopBonusNextMonth: row[2], coopBonus13th: row[3], isfAdd: row[4] }; });
                    lifeJson.slice(1).forEach(row => { if(row[0]) params.life.push({ company: row[0], recognitionRate: row[1], retentionRate: row[2], nextMonth: row[3], month13: row[4] }); });
                    expenseJson.slice(2).forEach(row => { if (row[0]) { params.expense[row[0]] = { commissionPreservation: row[1], otherDeduction: row[2], lossPreservation: row[3], isfTravelBonus: row[4], travelExpenseBonus20: row[5], travelExpenseBonus30: row[6], isfManagerTO: row[7], managerSpecialNextMonth: row[8], managerSpecial13th: row[9] }; } });
                    loadedIncomeParams = params;
                    incomeFileStatusDisplay.innerHTML = `<span class="text-green-600 font-bold">âœ… ìˆ˜ì… ì¡°ê±´ íŒŒì¼ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.</span>`;
                    checkRunButtonStatus();
                } catch (error) {
                    incomeFileStatusDisplay.innerHTML = `<span class="text-red-600 font-bold">âš ï¸ íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: ${error.message}</span>`;
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function handleIncomeSourceChange() {
            if (this.value === 'upload') {
                incomeUploadSection.classList.remove('hidden');
                incomeFileStatusDisplay.innerHTML = `ìˆ˜ì…ì¡°ê±´ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.`;
                loadedIncomeParams = null; 
            } else {
                incomeUploadSection.classList.add('hidden');
                loadedIncomeParams = JSON.parse(JSON.stringify(defaultIncomeParams)); // Reset to a deep copy of defaults
                incomeFileStatusDisplay.innerHTML = `ê¸°ë³¸ê°’ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            }
            checkRunButtonStatus();
        }

        function createScenarioInputs() {
            scenariosContainer.innerHTML = '';
            const defaults = [
                { growth: 10, monthly: 400000, total: 1300000 },
                { growth: 20, monthly: 400000, total: 1300000 },
                { growth: 30, monthly: 400000, total: 1300000 }
            ];
            for (let i = 1; i <= 3; i++) {
                const scenarioDiv = document.createElement('div');
                scenarioDiv.className = 'p-4 bg-gray-100/50 rounded-lg border border-gray-200'; /* Lighter background */
                scenarioDiv.innerHTML = `
                    <h3 class="text-base font-semibold text-blue-600 mb-3">ì‹œë‚˜ë¦¬ì˜¤ ${i}</h3>
                    <div class="space-y-2">
                        <div><label class="text-xs text-gray-700">ìƒìŠ¹/ê°ì†Œìœ¨</label><div class="relative flex items-center"><input type="number" id="growthRate${i}" class="w-full p-2 bg-gray-100 border border-gray-300 rounded-md text-right pr-10 text-gray-800" value="${defaults[i-1].growth}" step="1"><span class="absolute right-3 text-gray-500 pointer-events-none">(%)</span></div></div>
                        <div><label class="text-xs text-gray-700">ì›”ë³„ ì—°ì† ëª©í‘œ</label><div class="relative flex items-center"><input type="number" id="monthlyTarget${i}" class="w-full p-2 bg-gray-100 border border-gray-300 rounded-md text-right pr-10 text-gray-800" value="${defaults[i-1].monthly}" step="100000"><span class="absolute right-3 text-gray-500 pointer-events-none">(ì›)</span></div></div>
                        <div><label class="text-xs text-gray-700">3ê°œì›” í•©ì‚° ëª©í‘œ</label><div class="relative flex items-center"><input type="number" id="totalTarget${i}" class="w-full p-2 bg-gray-100 border border-gray-300 rounded-md text-right pr-10 text-gray-800" value="${defaults[i-1].total}" step="100000"><span class="absolute right-3 text-gray-500 pointer-events-none">(ì›)</span></div></div>
                    </div>`;
                scenariosContainer.appendChild(scenarioDiv);
            }
        }

        function downloadTemplate() {
            const wb = XLSX.utils.book_new();

            // 1. Non-Life Sheet
            const nonLifeData = [templateHeaders.nonLife];
            Object.keys(defaultIncomeParams.nonLife).forEach(company => {
                const p = defaultIncomeParams.nonLife[company];
                nonLifeData.push([company, p.retentionRate, p.coopBonusNextMonth, p.coopBonus13th, p.isfAdd]);
            });
            const wsNonLife = XLSX.utils.aoa_to_sheet(nonLifeData);
            XLSX.utils.book_append_sheet(wb, wsNonLife, 'ì†ë³´ìˆ˜ì…');

            // 2. Life Sheet
            const lifeData = [templateHeaders.life.map(h => h.replace(/\n/g, ' '))];
            defaultIncomeParams.life.forEach(rule => {
                lifeData.push([rule.company, rule.recognitionRate, rule.retentionRate, rule.nextMonth, rule.month13]);
            });
            const wsLife = XLSX.utils.aoa_to_sheet(lifeData);
            XLSX.utils.book_append_sheet(wb, wsLife, 'ìƒë³´ìˆ˜ì…');

            // 3. Expense Sheet
            const expenseData = [
                ['ì§€ì¶œí•­ëª©', '', '', '', 'ISF', '', '', 'ê´€ë¦¬ì', '', ''],
                templateHeaders.expense.map(h => h.replace(/\n/g, ' ')),
            ];
            Object.keys(defaultIncomeParams.expense).forEach(company => {
                const p = defaultIncomeParams.expense[company];
                expenseData.push([
                    company, p.commissionPreservation, p.otherDeduction, p.lossPreservation,
                    p.isfTravelBonus, p.travelExpenseBonus20, p.travelExpenseBonus30,
                    p.isfManagerTO, p.managerSpecialNextMonth, p.managerSpecial13th
                ]);
            });
            const wsExpense = XLSX.utils.aoa_to_sheet(expenseData);
            XLSX.utils.book_append_sheet(wb, wsExpense, 'ì§€ì¶œ');

            XLSX.writeFile(wb, 'ìˆ˜ì…ì§€ì¶œ_ì¡°ê±´_ì–‘ì‹.xlsx');
        }
        
        function attachEventListeners() {
            fileUploadButton.addEventListener('click', () => fileInput.click());
            incomeFileUploadLabel.addEventListener('click', () => incomeFileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            incomeFileInput.addEventListener('change', handleIncomeFileSelect);
            document.querySelectorAll('input[name="incomeSource"]').forEach(radio => radio.addEventListener('change', handleIncomeSourceChange));
            runButton.addEventListener('click', runSimulation);
            resultsContainer.addEventListener('click', handleResultsClick);
            closeModalBtn.addEventListener('click', () => {
                modal.classList.remove('opacity-100');
                setTimeout(() => modal.classList.add('hidden'), 300);
            });
            printButton.addEventListener('click', printReport);
            downloadTemplateBtn.addEventListener('click', downloadTemplate);
            editIncomeParamsBtn.addEventListener('click', openIncomeEditor);
            closeIncomeModalBtn.addEventListener('click', () => {
                incomeModal.classList.remove('opacity-100');
                setTimeout(() => incomeModal.classList.add('hidden'), 300);
            });
            saveIncomeParamsBtn.addEventListener('click', saveIncomeParams);
            // New event listeners for save/load
            saveButton.addEventListener('click', saveAppState);
            loadButton.addEventListener('click', () => loadStateInput.click()); // Trigger hidden file input
            loadStateInput.addEventListener('change', loadAppState); // Handle file selection for loading
        }

        function openIncomeEditor() {
            if (!loadedIncomeParams) {
                statusDiv.innerText = 'âš ï¸ ìˆ˜ì… ì¡°ê±´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•˜ê±°ë‚˜ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.';
                setTimeout(() => statusDiv.innerText = '', 3000);
                return;
            }

            let html = '';

            html += '<h3 class="text-lg font-semibold text-cyan-700 mb-2">ì†ë³´ìˆ˜ì…</h3>';
            html += '<div class="overflow-x-auto"><table id="nonLifeTable" class="w-full text-sm text-left text-gray-800"><thead><tr class="text-xs text-gray-600 uppercase bg-gray-100">'; /* Lighter table headers */
            templateHeaders.nonLife.forEach(h => html += `<th class="px-4 py-2">${h.replace('\n', '<br>')}</th>`);
            html += '</tr></thead><tbody>';
            for (const company in loadedIncomeParams.nonLife) {
                const params = loadedIncomeParams.nonLife[company];
                html += `<tr class="border-b border-gray-200">
                    <td class="px-4 py-2 font-medium">${company}</td>
                    <td><input type="number" step="0.01" class="w-24 p-1 bg-gray-100 border border-gray-300 rounded text-gray-800" value="${params.retentionRate}"></td>
                    <td><input type="number" step="0.1" class="w-24 p-1 bg-gray-100 border border-gray-300 rounded text-gray-800" value="${params.coopBonusNextMonth}"></td>
                    <td><input type="number" step="0.01" class="w-24 p-1 bg-gray-100 border border-gray-300 rounded text-gray-800" value="${params.coopBonus13th}"></td>
                    <td><input type="number" step="0.1" class="w-24 p-1 bg-gray-100 border border-gray-300 rounded text-gray-800" value="${params.isfAdd}"></td>
                </tr>`;
            }
            html += '</tbody></table></div>';

            html += '<h3 class="text-lg font-semibold text-cyan-700 mt-6 mb-2">ìƒë³´ìˆ˜ì…</h3>';
            html += '<div class="overflow-x-auto"><table id="lifeTable" class="w-full text-sm text-left text-gray-800"><thead><tr class="text-xs text-gray-600 uppercase bg-gray-100">'; /* Lighter table headers */
            templateHeaders.life.forEach(h => html += `<th class="px-4 py-2">${h.replace('\n', '<br>')}</th>`);
            html += '</tr></thead><tbody>';
            loadedIncomeParams.life.forEach((rule, index) => {
                html += `<tr class="border-b border-gray-200">
                    <td class="px-4 py-2 font-medium">${rule.company}</td>
                    <td><input type="number" class="w-24 p-1 bg-gray-100 border border-gray-300 rounded text-gray-800" value="${rule.recognitionRate}"></td>
                    <td><input type="number" step="0.01" class="w-24 p-1 bg-gray-100 border border-gray-300 rounded text-gray-800" value="${rule.retentionRate}"></td>
                    <td><input type="number" step="0.1" class="w-24 p-1 bg-gray-100 border border-gray-300 rounded text-gray-800" value="${rule.nextMonth}"></td>
                    <td><input type="number" step="0.1" class="w-24 p-1 bg-gray-100 border border-gray-300 rounded text-gray-800" value="${rule.month13}"></td>
                </tr>`;
            });
            html += '</tbody></table></div>';

            html += '<h3 class="text-lg font-semibold text-cyan-700 mt-6 mb-2">ì§€ì¶œ</h3>';
            html += '<div class="overflow-x-auto"><table id="expenseTable" class="w-full text-sm text-left text-gray-800"><thead><tr class="text-xs text-gray-600 uppercase bg-gray-100">'; /* Lighter table headers */
            templateHeaders.expense.forEach(h => html += `<th class="px-4 py-2">${h.replace(/\n/g, ' ')}</th>`);
            html += '</tr></thead><tbody>';
            for (const company in loadedIncomeParams.expense) {
                const params = loadedIncomeParams.expense[company];
                html += `<tr class="border-b border-gray-200">
                    <td class="px-4 py-2 font-medium">${company}</td>
                    <td><input type="number" step="0.1" class="w-20 p-1 bg-gray-100 border border-gray-300 rounded text-gray-800" value="${params.commissionPreservation}"></td>
                    <td><input type="number" step="0.01" class="w-20 p-1 bg-gray-100 border border-gray-300 rounded text-gray-800" value="${params.otherDeduction}"></td>
                    <td><input type="number" step="0.1" class="w-20 p-1 bg-gray-100 border border-gray-300 rounded text-gray-800" value="${params.lossPreservation}"></td>
                    <td><input type="number" step="0.1" class="w-20 p-1 bg-gray-100 border border-gray-300 rounded text-gray-800" value="${params.isfTravelBonus}"></td>
                    <td><input type="number" step="0.1" class="w-20 p-1 bg-gray-100 border border-gray-300 rounded text-gray-800" value="${params.travelExpenseBonus20}"></td>
                    <td><input type="number" step="0.1" class="w-20 p-1 bg-gray-100 border border-gray-300 rounded text-gray-800" value="${params.travelExpenseBonus30}"></td>
                    <td><input type="number" step="0.1" class="w-20 p-1 bg-gray-100 border border-gray-300 rounded text-gray-800" value="${params.isfManagerTO}"></td>
                    <td><input type="number" step="0.1" class="w-20 p-1 bg-gray-100 border border-gray-300 rounded text-gray-800" value="${params.managerSpecialNextMonth}"></td>
                    <td><input type="number" step="0.1" class="w-20 p-1 bg-gray-100 border border-gray-300 rounded text-gray-800" value="${params.managerSpecial13th}"></td>
                </tr>`;
            }
            html += '</tbody></table></div>';

            incomeModalBody.innerHTML = html;
            incomeModal.classList.remove('hidden');
            setTimeout(() => incomeModal.classList.add('opacity-100'), 10);
        }

        function saveIncomeParams() {
            const newParams = { nonLife: {}, life: [], expense: {} };

            const nonLifeRows = document.querySelectorAll('#nonLifeTable tbody tr');
            nonLifeRows.forEach(row => {
                const cells = row.querySelectorAll('td, input');
                const company = cells[0].textContent;
                newParams.nonLife[company] = {
                    retentionRate: parseFloat(cells[1].value),
                    coopBonusNextMonth: parseFloat(cells[2].value),
                    coopBonus13th: parseFloat(cells[3].value),
                    isfAdd: parseFloat(cells[4].value)
                };
            });

            const lifeRows = document.querySelectorAll('#lifeTable tbody tr');
            lifeRows.forEach(row => {
                const cells = row.querySelectorAll('td, input');
                newParams.life.push({
                    company: cells[0].textContent,
                    recognitionRate: parseFloat(cells[1].value),
                    retentionRate: parseFloat(cells[2].value),
                    nextMonth: parseFloat(cells[3].value),
                    month13: parseFloat(cells[4].value)
                });
            });

            const expenseRows = document.querySelectorAll('#expenseTable tbody tr');
            expenseRows.forEach(row => {
                const cells = row.querySelectorAll('td, input');
                const company = cells[0].textContent;
                newParams.expense[company] = {
                    commissionPreservation: parseFloat(cells[1].value),
                    otherDeduction: parseFloat(cells[2].value),
                    lossPreservation: parseFloat(cells[3].value),
                    isfTravelBonus: parseFloat(cells[4].value),
                    travelExpenseBonus20: parseFloat(cells[5].value),
                    travelExpenseBonus30: parseFloat(cells[6].value),
                    isfManagerTO: parseFloat(cells[7].value),
                    managerSpecialNextMonth: parseFloat(cells[8].value),
                    managerSpecial13th: parseFloat(cells[9].value)
                };
            });

            loadedIncomeParams = newParams;
            incomeFileStatusDisplay.innerHTML = `<span class="text-yellow-600 font-bold">âœ… í¸ì§‘ëœ ìˆ˜ì… ì¡°ê±´ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</span>`;

            incomeModal.classList.remove('opacity-100');
            setTimeout(() => incomeModal.classList.add('hidden'), 300);
        }

        function saveAppState() {
            statusDiv.innerHTML = '<span class="text-blue-600">ğŸ”„ íŒŒì¼ ì €ì¥ ì¤‘...</span>';
            const scenarios = [];
            for (let i = 1; i <= 3; i++) {
                scenarios.push({
                    id: i,
                    growthRate: parseFloat(document.getElementById(`growthRate${i}`).value) || 0,
                    monthlyTarget: parseFloat(document.getElementById(`monthlyTarget${i}`).value) || 0,
                    totalTarget: parseFloat(document.getElementById(`totalTarget${i}`).value) || 0
                });
            }
            const commonParams = {
                tripAttendanceRate: parseFloat(document.getElementById('tripAttendanceRate').value) || 100,
                tripCostPerPerson: parseFloat(document.getElementById('tripCostPerPerson').value) || 0,
                nonAttendeePayout: parseFloat(document.getElementById('nonAttendeePayout').value) || 0,
                attendingCompanions: parseFloat(document.getElementById('attendingCompanions').value) || 0
            };
            const excludeDirectFamily = document.getElementById('excludeDirectFamily').checked;

            const appState = {
                performanceData: loadedJsonData,
                incomeParameters: loadedIncomeParams,
                scenarios: scenarios,
                commonParameters: commonParams,
                excludeDirectFamily: excludeDirectFamily
            };

            const jsonString = JSON.stringify(appState, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'promotion_simulator_state.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // Clean up the object URL

            statusDiv.innerHTML = '<span class="text-green-600">âœ… í˜„ì¬ ìƒíƒœê°€ íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</span>';
            setTimeout(() => statusDiv.innerText = '', 5000);
        }

        function loadAppState(event) {
            statusDiv.innerHTML = '<span class="text-blue-600">ğŸ”„ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>';
            const file = event.target.files[0];
            if (!file) {
                statusDiv.innerHTML = '<span class="text-red-600">âš ï¸ íŒŒì¼ì„ ì„ íƒí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</span>';
                setTimeout(() => statusDiv.innerText = '', 3000);
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const loadedState = JSON.parse(e.target.result);
                    
                    // Restore loadedJsonData
                    loadedJsonData = loadedState.performanceData;
                    if (loadedJsonData && loadedJsonData.length > 0) {
                        dataStatusDisplay.innerHTML = `<span class="text-green-600 font-bold">âœ… ì´ ${loadedJsonData.length.toLocaleString()} ê±´ì˜ ë°ì´í„°ê°€ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤.</span>`;
                    } else {
                        dataStatusDisplay.innerHTML = `'ì‹¤ì ì—‘ì…€íŒŒì¼ì–‘ì‹'ì— ë§ì¶° ì‘ì„±ëœ íŒŒì¼ì„ ì—…ë¡œë“œ í•´ì£¼ì„¸ìš”.`;
                    }

                    // Restore loadedIncomeParams
                    loadedIncomeParams = loadedState.incomeParameters;
                    if (loadedIncomeParams) {
                        incomeFileStatusDisplay.innerHTML = `<span class="text-green-600 font-bold">âœ… ìˆ˜ì… ì¡°ê±´ íŒŒì¼ì´ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤.</span>`;
                        // Set income source radio to default, as loaded data acts like a custom default
                        document.querySelector('input[name="incomeSource"][value="default"]').checked = true;
                        incomeUploadSection.classList.add('hidden');
                    } else {
                        incomeFileStatusDisplay.innerHTML = `ê¸°ë³¸ê°’ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                        document.querySelector('input[name="incomeSource"][value="default"]').checked = true;
                        incomeUploadSection.classList.add('hidden');
                    }

                    // Restore scenarios
                    if (loadedState.scenarios) {
                        loadedState.scenarios.forEach((s, i) => {
                            const scenarioId = i + 1;
                            document.getElementById(`growthRate${scenarioId}`).value = s.growthRate;
                            document.getElementById(`monthlyTarget${scenarioId}`).value = s.monthlyTarget;
                            document.getElementById(`totalTarget${scenarioId}`).value = s.totalTarget;
                        });
                    }

                    // Restore common parameters
                    if (loadedState.commonParameters) {
                        document.getElementById('tripAttendanceRate').value = loadedState.commonParameters.tripAttendanceRate;
                        document.getElementById('tripCostPerPerson').value = loadedState.commonParameters.tripCostPerPerson;
                        document.getElementById('nonAttendeePayout').value = loadedState.commonParameters.nonAttendeePayout;
                        document.getElementById('attendingCompanions').value = loadedState.commonParameters.attendingCompanions;
                    }

                    // Restore excludeDirectFamily checkbox
                    document.getElementById('excludeDirectFamily').checked = loadedState.excludeDirectFamily;

                    statusDiv.innerHTML = `<span class="text-green-600">âœ… ìƒíƒœê°€ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤.</span>`;
                    checkRunButtonStatus(); // Re-evaluate run button status
                } catch (error) {
                    statusDiv.innerHTML = `<span class="text-red-600">âš ï¸ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ${error.message}</span>`;
                }
                setTimeout(() => statusDiv.innerText = '', 5000);
            };
            reader.readAsText(file); // Read the file as text for JSON parsing
        }

        function runSimulation() {
            statusDiv.innerHTML = '';
            if (!loadedJsonData || !loadedIncomeParams) { statusDiv.innerText = 'âš ï¸ ì‹¤ì  ë°ì´í„°ì™€ ìˆ˜ì… ì¡°ê±´ì´ ëª¨ë‘ ì¤€ë¹„ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.'; return; }
            const scenarios = [];
            for (let i = 1; i <= 3; i++) {
                scenarios.push({ id: i, growthRate: parseFloat(document.getElementById(`growthRate${i}`).value) || 0, monthlyTarget: parseFloat(document.getElementById(`monthlyTarget${i}`).value) || 0, totalTarget: parseFloat(document.getElementById(`totalTarget${i}`).value) || 0 });
            }
            const commonParams = {
                tripAttendanceRate: parseFloat(document.getElementById('tripAttendanceRate').value) || 100,
                tripCostPerPerson: parseFloat(document.getElementById('tripCostPerPerson').value) || 0,
                nonAttendeePayout: parseFloat(document.getElementById('nonAttendeePayout').value) || 0,
                attendingCompanions: parseFloat(document.getElementById('attendingCompanions').value) || 0
            };
            const excludeDirectFamily = document.getElementById('excludeDirectFamily').checked;

            resultsContainer.innerHTML = '<div class="text-center py-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-600 mx-auto"></div><p class="mt-4 text-gray-700">ë°±ê·¸ë¼ìš´ë“œì—ì„œ ê³„ì‚° ì¤‘...</p></div>';
            runButton.disabled = true; runButton.textContent = 'â³ ê³„ì‚° ì¤‘...';
            printButton.disabled = true;
            const workerScript = document.getElementById('worker').textContent;
            const workerBlob = new Blob([workerScript], { type: 'application/javascript' });
            worker = new Worker(URL.createObjectURL(workerBlob));
            worker.postMessage({ jsonData: loadedJsonData, scenarios, incomeParams: loadedIncomeParams, commonParams, excludeDirectFamily });
            
            worker.onmessage = function(e) {
                runButton.disabled = false; runButton.textContent = 'ğŸ“Š ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ ë° ìˆ˜ì… ê³„ì‚°'; if(worker) worker.terminate();
                const { results, error } = e.data;
                if (error) { statusDiv.innerText = `âš ï¸ ${error}`; resultsContainer.innerHTML = ''; } 
                else if (!results || results.length === 0) { resultsContainer.innerHTML = '<p class="text-gray-500 text-center pt-16">ìœ íš¨í•œ ì‹œë‚˜ë¦¬ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';} 
                else {
                    let summaryText = '<strong class="text-gray-900">ì‹œë‚˜ë¦¬ì˜¤ë³„ ì´ ë™ë°˜ì¸ì›:</strong> ';
                    const summaryParts = results.map(res => `ì‹œë‚˜ë¦¬ì˜¤ ${res.id}: <span class="font-bold text-cyan-600">${res.totalCompanions}</span>ëª…`);
                    summaryText += summaryParts.join(', ');
                    companionSummaryDiv.innerHTML = summaryText;
                    companionSummaryDiv.classList.remove('hidden');

                    resultsContainer.innerHTML = '<h2 class="text-2xl font-semibold mb-4 text-gray-800">4. ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼</h2>';
                    const resultsGrid = document.createElement('div');
                    resultsGrid.className = 'grid grid-cols-1 lg:grid-cols-3 gap-6';
                    results.forEach(res => {
                        const scenarioInput = scenarios.find(s => s.id === res.id);
                        if(scenarioInput) {
                            res.growthRate = scenarioInput.growthRate;
                        }
                        res.attendingCompanions = commonParams.attendingCompanions;
                        res.tripAttendanceRate = commonParams.tripAttendanceRate;
                        res.excludeDirectFamily = excludeDirectFamily; // Store the checkbox status with the result
                        scenarioResultsData[res.id] = res;

                        const summaryHtml = `<div class="bg-gray-100 p-3 rounded-md text-sm max-h-40 overflow-y-auto"><p class="text-gray-700 font-medium mb-2">ğŸ“ˆ ë³´í—˜ì‚¬ë³„ ì˜ˆìƒ ì‹¤ì :</p><div class="grid grid-cols-2 gap-x-4 gap-y-1 text-gray-800"><span class="font-semibold text-teal-600">ìƒëª…ë³´í—˜ í•©ê³„:</span> <span class="text-right">${Math.round(res.performanceSummary.life).toLocaleString()}</span><span class="font-semibold text-teal-600">ì†í•´ë³´í—˜ í•©ê³„:</span> <span class="text-right">${Math.round(res.performanceSummary.nonLife).toLocaleString()}</span>${Object.entries(res.performanceSummary.byCompany).sort((a, b) => b[1] - a[1]).map(([company, total]) => `<span>${company}:</span> <span class="text-right">${Math.round(total).toLocaleString()}</span>`).join('')}</div></div>`;
                        const nonAchieverHtml = `<div class="mt-3 bg-gray-100 p-4 rounded-md text-xs"><p class="text-gray-700 font-medium mb-3 text-center">ğŸ’¸ ë¯¸ë‹¬ì„±ì íŠ¹ë³„ ì‹œìƒ</p><div class="grid grid-cols-2 gap-4 text-center"><div><p class="font-semibold text-gray-700">3ê°œì›” í•©ì‚°<br>(40~80ë§Œ)</p><p class="text-base font-bold text-yellow-600 mt-1">${res.nonAchieverCounts['40ë§Œì  ì‹œìƒ'] || 0}ëª…</p></div><div><p class="font-semibold text-gray-700">3ê°œì›” í•©ì‚°<br>(80~130ä¸‡)</p><p class="text-base font-bold text-yellow-600 mt-1">${res.nonAchieverCounts['80ë§Œì  ì‹œìƒ'] || 0}ëª…</p></div></div></div>`;
                        const mainTiersHtml = `<div class="grid grid-cols-4 gap-4 text-center">${['1êµ¬ê°„', '2êµ¬ê°„', '3êµ¬ê°„', '4êµ¬ê°„'].map(tierName => `<div><p class="font-semibold text-gray-700">${tierName}</p><p class="text-base font-bold text-yellow-600 mt-1">${res.tierCounts[tierName] || 0}ëª…</p></div>`).join('')}</div>`;
                        const superTiersHtml = `<div class="grid grid-cols-3 gap-4 text-center mt-3 pt-3 border-t border-gray-300">${['4êµ¬ê°„ ì´ˆê³¼(600ë§Œ)', '4êµ¬ê°„ ì´ˆê³¼(800ë§Œ)', '4êµ¬ê°„ ì´ˆê³¼(1000ë§Œ)'].map(tierName => `<div><p class="font-semibold text-gray-700">${tierName.replace('4êµ¬ê°„ ', '')}</p><p class="text-base font-bold text-yellow-600 mt-1">${res.tierCounts[tierName] || 0}ëª…</p></div>`).join('')}</div>`;
                        const tierCountsHtml = `<div class="mt-3 bg-gray-100 p-4 rounded-md text-xs"><p class="text-gray-700 font-medium mb-3 text-center">ğŸ† êµ¬ê°„ë³„ ë‹¬ì„± í˜„í™©</p>${mainTiersHtml}${superTiersHtml}</div>`;
                        const incomeDetails = res.incomeDetails;
                        const incomeHtml = `<div class="mt-3 bg-gray-100 p-3 rounded-md text-sm"><p class="text-gray-700 font-medium mb-2">ğŸ’° ì˜ˆìƒ ìˆ˜ì… ë¶„ì„:</p><div class="space-y-1 text-gray-800"><div class="flex justify-between text-green-600"><span>(+) ì´ìˆ˜ì…:</span> <span>${Math.round(incomeDetails.totalRevenue).toLocaleString()} ì›</span></div><div class="flex justify-between text-red-600"><span>(-) ì´ì§€ì¶œ:</span> <span>${Math.round(incomeDetails.totalDeduction).toLocaleString()} ì›</span></div><hr class="border-gray-300 my-1"><div class="flex justify-between font-bold text-lg text-cyan-700"><span>ìµœì¢…ì˜ˆìƒìˆ˜ìµ:</span> <span>${Math.round(incomeDetails.finalIncome).toLocaleString()} ì›</span></div></div><button data-scenario-id="${res.id}" class="details-btn mt-2 w-full text-xs text-cyan-600 hover:underline">ìƒì„¸ ë‚´ì—­ ë³´ê¸°</button></div>`;
                        const resultCard = document.createElement('div');
                        resultCard.className = 'bg-white p-5 rounded-lg border border-gray-200'; /* Lighter card background */
                        resultCard.innerHTML = `<h3 class="text-xl font-bold text-teal-600 mb-2">ì‹œë‚˜ë¦¬ì˜¤ ${res.id} ê²°ê³¼</h3><div class="text-center mb-3"><p class="text-lg font-semibold text-gray-800">ì´ ë‹¬ì„± ì¸ì›: <span class="text-2xl font-bold text-yellow-600">${res.achievers.length.toLocaleString()}</span>ëª…</p></div>${tierCountsHtml}${nonAchieverHtml}<div class="mt-4">${summaryHtml}</div><div class="mt-4">${incomeHtml}</div><button data-scenario-id="${res.id}" class="download-btn mt-4 w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-3 rounded-lg text-sm transition duration-300">ğŸ’¾ ê²°ê³¼ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>`;
                        resultsGrid.appendChild(resultCard);
                    });
                    resultsContainer.innerHTML = '';
                    resultsContainer.appendChild(resultsGrid);
                    printButton.disabled = false;
                }
            };
            worker.onerror = (e) => {
                statusDiv.innerText = `âš ï¸ ì›Œì»¤ ì˜¤ë¥˜ ë°œìƒ: ${e.message}`;
                runButton.disabled = false; runButton.textContent = 'ğŸ“Š ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ ë° ìˆ˜ì… ê³„ì‚°'; if(worker) worker.terminate();
            };
        }

        function handleResultsClick(event) {
            const target = event.target;
            const scenarioId = target.dataset.scenarioId;
            if (!scenarioId) return;
            
            const dataToExport = scenarioResultsData[scenarioId];
            if (!dataToExport) return;

            if (target.classList.contains('download-btn')) {
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dataToExport.achievers), 'ë‹¬ì„±ì ëª…ë‹¨');
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dataToExport.allEmployeesData), 'ì „ì²´ ì‹¤ì  í˜„í™©');
                
                const totalDetails = dataToExport.incomeDetails;
                const companyDetails = dataToExport.incomeDetailsByCompany;
                const lifeDetails = dataToExport.incomeDetails.lifeInsuranceRevenueDetails;
                const detailsData = [];
                detailsData.push(['ì´ìˆ˜ì… (+)']);
                detailsData.push(['í•­ëª©', 'ê¸ˆì•¡', 'ì‚°ì¶œê·¼ê±°']);
                if(lifeDetails) {
                    detailsData.push(['[ìƒëª…ë³´í—˜]']);
                    for(const [company, details] of Object.entries(lifeDetails)){
                        detailsData.push([`${company} ìƒìƒì‹œìƒ(ìµì›”)`, Math.round(details.bonusNextMonth), 'ìµœì´ˆì¸ì •ì‹¤ì  Ã— ì‹œìƒë¥ ']);
                        detailsData.push([`${company} ìƒìƒì‹œìƒ(13íšŒ)`, Math.round(details.bonus13th), 'ìµœì´ˆì¸ì •ì‹¤ì  Ã— ì‹œìƒë¥  Ã— ìœ ì§€ìœ¨']);
                    }
                }
                if(companyDetails) {
                    detailsData.push(['[ì†í•´ë³´í—˜]']);
                    for(const [company, cDetails] of Object.entries(companyDetails)){
                        const d = cDetails.details;
                        detailsData.push([`${company} ìƒìƒì‹œìƒ(ìµì›”)`, Math.round(d.bonusNextMonth), 'ì‹¤ì  Ã— ì‹œìƒë¥ ']);
                        detailsData.push([`${company} ìƒìƒì‹œìƒ(13íšŒ)`, Math.round(d.bonus13th), 'ì‹¤ì  Ã— ì‹œìƒë¥  Ã— ìœ ì§€ìœ¨']);
                        detailsData.push([`${company} ISFì¶”ê°€`, Math.round(d.bonusISF), 'ì‹¤ì  Ã— ì‹œì±…ë¥ ']);
                    }
                }
                detailsData.push(['[ê³µí†µ]']);
                detailsData.push(['ë‹¬ì„±ì(FA) ë¹„ì°¸ì„ì ìˆœìˆ˜ìµ', Math.round(totalDetails.netNonAttendeeFAIncome), '(ì—¬í–‰ê²½ë¹„ - ì§€ê¸‰ì•¡) Ã— FA ë¹„ì°¸ì„ ì¸ì›']);
                detailsData.push(['ë™ë°˜ì¸ ë¹„ì°¸ì„ì ìˆœìˆ˜ìµ', Math.round(totalDetails.companionNetIncome), '(ì—¬í–‰ê²½ë¹„ - ì§€ê¸‰ì•¡) Ã— (ì´ ë™ë°˜ì¸ì› - ì°¸ì„ì¸ì›)']);
                detailsData.push(['ì´ìˆ˜ì… í•©ê³„', Math.round(totalDetails.totalRevenue), '']);
                detailsData.push([]);
                detailsData.push(['ì´ì§€ì¶œ (-)']);
                detailsData.push(['í•­ëª©', 'ê¸ˆì•¡', 'ì‚°ì¶œê·¼ê±°']);
                if(companyDetails){
                    for(const [company, cDetails] of Object.entries(companyDetails)){
                        const d = cDetails.details;
                        detailsData.push([`${company} ISF ì—¬í–‰ì‹œìƒ`, Math.round(d.dedIsfTravel), 'ì‹¤ì  Ã— ì‹œìƒë¥ ']);
                        detailsData.push([`${company} ì—¬í–‰ê²½ë¹„ì¶”ê°€`, Math.round(d.dedTravelExpense), 'ì‚¬ì›/ì›”/ë³´í—˜ì‚¬ë³„ ì‹¤ì  Ã— êµ¬ê°„ë³„ ì‹œìƒë¥ ']);
                        detailsData.push([`${company} ìˆ˜ìˆ˜ë£Œì„ ì§€ê¸‰ë³´ì¡´`, Math.round(d.dedCommission), 'ì‹¤ì  Ã— ê³µì œìœ¨']);
                        detailsData.push([`${company} ê¸°íƒ€ ê³µì œ`, Math.round(d.dedOther), 'ì‹¤ì  Ã— ê³µì œìœ¨']);
                        detailsData.push([`${company} ì†ì‹¤ë³´ì „`, Math.round(d.dedLoss), 'ì‹¤ì  Ã— ê³µì œìœ¨']);
                        detailsData.push([`${company} ê´€ë¦¬ìT/O`, Math.round(d.dedManagerTO), 'ì‹¤ì  Ã— ê³µì œìœ¨']);
                        detailsData.push([`${company} ìµì›”_ê´€ë¦¬ìíŠ¹ë³„ì‹œì±…`, Math.round(d.dedManagerSpecialNextMonth), 'ì‹¤ì  Ã— ì‹œì±…ë¥ ']);
                        detailsData.push([`${company} 13íšŒ_ê´€ë¦¬ìíŠ¹ë³„ì‹œì±…`, Math.round(d.dedManagerSpecial13th), 'ì‹¤ì  Ã— ì‹œì±…ë¥  Ã— ìœ ì§€ìœ¨']);
                    }
                }
                detailsData.push(['4êµ¬ê°„ ì´ˆê³¼ë‹¬ì„± ì‹œìƒê¸ˆ', Math.round(totalDetails.totalTierCashBonus), 'ë‹¬ì„±ìë³„ ì¶”ê°€ì‹œìƒê¸ˆ í•©ì‚°']);
                detailsData.push(['ë¯¸ë‹¬ì„±ì íŠ¹ë³„ ì‹œìƒê¸ˆ', Math.round(totalDetails.totalMonthlyNonAchieverBonus), 'ë¯¸ë‹¬ì„±ì 3ê°œì›” í•©ì‚° ì‹¤ì  êµ¬ê°„ë³„ ì‹œìƒ í•©ì‚°']);
                detailsData.push(['ì´ì§€ì¶œ í•©ê³„', Math.round(totalDetails.totalDeduction), '']);
                detailsData.push([]);
                detailsData.push(['ìµœì¢… ì˜ˆìƒ ìˆ˜ìµ', Math.round(totalDetails.finalIncome), 'ì´ìˆ˜ì… - ì´ì§€ì¶œ']);
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(detailsData), 'ìƒì„¸ ìˆ˜ì… ë‚´ì—­');
                XLSX.writeFile(wb, `ì‹œë‚˜ë¦¬ì˜¤${scenarioId}_ê²°ê³¼.xlsx`);

            } else if (target.classList.contains('details-btn')) {
                modalTitle.textContent = `ì‹œë‚˜ë¦¬ì˜¤ ${scenarioId} ìƒì„¸ ìˆ˜ì… ë‚´ì—­`;
                let tableHtml = '<div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-800"><thead><tr class="text-xs text-gray-600 uppercase bg-gray-100"><th class="px-4 py-2">í•­ëª©</th><th class="px-4 py-2 text-right">ê¸ˆì•¡</th><th class="px-4 py-2">ì‚°ì¶œê·¼ê±°</th></tr></thead><tbody>'; /* Lighter modal table headers */
                const totalDetails = dataToExport.incomeDetails;
                const companyDetails = dataToExport.incomeDetailsByCompany;
                const lifeDetails = dataToExport.incomeDetails.lifeInsuranceRevenueDetails;
                
                tableHtml += `<tr class="border-b border-gray-200 bg-gray-100/50"><td colspan="3" class="px-4 py-2 font-bold text-teal-700">ì´ìˆ˜ì… (+)</td></tr>`;
                if(lifeDetails && Object.keys(lifeDetails).length > 0) {
                    tableHtml += `<tr class="border-b border-gray-200 bg-gray-50/50"><td colspan="3" class="px-4 py-2 font-semibold text-teal-600">[ìƒëª…ë³´í—˜]</td></tr>`;
                    for(const [company, details] of Object.entries(lifeDetails)){
                        tableHtml += `<tr class="border-b border-gray-200"><td class="pl-8 py-2">${company} ìƒìƒì‹œìƒ(ìµì›”)</td><td class="px-4 py-2 text-right text-green-600">${Math.round(details.bonusNextMonth).toLocaleString()}</td><td class="px-4 py-2 text-xs text-gray-500">ìµœì´ˆì¸ì •ì‹¤ì  Ã— ì‹œìƒë¥ </td></tr>`;
                        tableHtml += `<tr class="border-b border-gray-200"><td class="pl-8 py-2">${company} ìƒìƒì‹œìƒ(13íšŒ)</td><td class="px-4 py-2 text-right text-green-600">${Math.round(details.bonus13th).toLocaleString()}</td><td class="px-4 py-2 text-xs text-gray-500">ìµœì´ˆì¸ì •ì‹¤ì  Ã— ì‹œìƒë¥  Ã— ìœ ì§€ìœ¨</td></tr>`;
                    }
                }
                if(companyDetails && Object.keys(companyDetails).length > 0) {
                    tableHtml += `<tr class="border-b border-gray-200 bg-gray-50/50"><td colspan="3" class="px-4 py-2 font-semibold text-teal-600">[ì†í•´ë³´í—˜]</td></tr>`;
                    for(const [company, cDetails] of Object.entries(companyDetails)){
                        const d = cDetails.details;
                        tableHtml += `<tr class="border-b border-gray-200"><td class="pl-8 py-2">${company} ìƒìƒì‹œìƒ(ìµì›”)</td><td class="px-4 py-2 text-right text-green-600">${Math.round(d.bonusNextMonth).toLocaleString()}</td><td class="px-4 py-2 text-xs text-gray-500">ì‹¤ì  Ã— ì‹œìƒë¥ </td></tr>`;
                        tableHtml += `<tr class="border-b border-gray-200"><td class="pl-8 py-2">${company} ìƒìƒì‹œìƒ(13íšŒ)</td><td class="px-4 py-2 text-right text-green-600">${Math.round(d.bonus13th).toLocaleString()}</td><td class="px-4 py-2 text-xs text-gray-500">ì‹¤ì  Ã— ì‹œìƒë¥  Ã— ìœ ì§€ìœ¨</td></tr>`;
                        tableHtml += `<tr class="border-b border-gray-200"><td class="pl-8 py-2">${company} ISFì¶”ê°€</td><td class="px-4 py-2 text-right text-green-600">${Math.round(d.bonusISF).toLocaleString()}</td><td class="px-4 py-2 text-xs text-gray-500">ì‹¤ì  Ã— ì‹œì±…ë¥ </td></tr>`;
                    }
                }
                tableHtml += `<tr class="border-b border-gray-200 bg-gray-50/50"><td colspan="3" class="px-4 py-2 font-semibold text-teal-600">[ê³µí†µ]</td></tr>`;
                tableHtml += `<tr class="border-b border-gray-200"><td class="pl-8 py-2">ë‹¬ì„±ì(FA) ë¹„ì°¸ì„ì ìˆœìˆ˜ìµ</td><td class="px-4 py-2 text-right text-green-600">${Math.round(totalDetails.netNonAttendeeFAIncome).toLocaleString()}</td><td class="px-4 py-2 text-xs text-gray-500">(ì—¬í–‰ê²½ë¹„ - ì§€ê¸‰ì•¡) Ã— FA ë¹„ì°¸ì„ ì¸ì›</td></tr>`;
                tableHtml += `<tr class="border-b border-gray-200"><td class="pl-8 py-2">ë™ë°˜ì¸ ë¹„ì°¸ì„ì ìˆœìˆ˜ìµ</td><td class="px-4 py-2 text-right text-green-600">${Math.round(totalDetails.companionNetIncome).toLocaleString()}</td><td class="px-4 py-2 text-xs text-gray-500">(ì—¬í–‰ê²½ë¹„ - ì§€ê¸‰ì•¡) Ã— (ì´ ë™ë°˜ì¸ì› - ì°¸ì„ì¸ì›)</td></tr>`;
                tableHtml += `<tr class="border-b border-gray-200 bg-gray-100"><td class="px-4 py-2 font-bold">ì´ìˆ˜ì… í•©ê³„</td><td class="px-4 py-2 text-right font-bold text-green-600">${Math.round(totalDetails.totalRevenue).toLocaleString()}</td><td></td></tr>`;
                tableHtml += `<tr class="border-b border-gray-200 bg-gray-100/50"><td colspan="3" class="px-4 py-2 font-bold text-red-700">ì´ì§€ì¶œ (-)</td></tr>`;
                if(companyDetails){
                    for(const [company, cDetails] of Object.entries(companyDetails)){
                        const d = cDetails.details;
                        tableHtml += `<tr class="border-b border-gray-200"><td class="pl-8 py-2">${company} ISF ì—¬í–‰ì‹œìƒ</td><td class="px-4 py-2 text-right text-red-600">${Math.round(d.dedIsfTravel).toLocaleString()}</td><td class="px-4 py-2 text-xs text-gray-500">ì‹¤ì  Ã— ì‹œìƒë¥ </td></tr>`;
                        tableHtml += `<tr class="border-b border-gray-200"><td class="pl-8 py-2">${company} ì—¬í–‰ê²½ë¹„ì¶”ê°€</td><td class="px-4 py-2 text-right text-red-600">${Math.round(d.dedTravelExpense).toLocaleString()}</td><td class="px-4 py-2 text-xs text-gray-500">ì›”ë³„/ì‚¬ì›ë³„ ì‹¤ì  Ã— êµ¬ê°„ë³„ ì‹œìƒë¥ </td></tr>`;
                        tableHtml += `<tr class="border-b border-gray-200"><td class="pl-8 py-2">${company} ìˆ˜ìˆ˜ë£Œì„ ì§€ê¸‰ë³´ì¡´</td><td class="px-4 py-2 text-right text-red-600">${Math.round(d.dedCommission).toLocaleString()}</td><td class="px-4 py-2 text-xs text-gray-500">ì‹¤ì  Ã— ê³µì œìœ¨</td></tr>`;
                        tableHtml += `<tr class="border-b border-gray-200"><td class="pl-8 py-2">${company} ê¸°íƒ€ ê³µì œ</td><td class="px-4 py-2 text-right text-red-600">${Math.round(d.dedOther).toLocaleString()}</td><td class="px-4 py-2 text-xs text-gray-500">ì‹¤ì  Ã— ê³µì œìœ¨</td></tr>`;
                        tableHtml += `<tr class="border-b border-gray-200"><td class="pl-8 py-2">${company} ì†ì‹¤ë³´ì „</td><td class="px-4 py-2 text-right text-red-600">${Math.round(d.dedLoss).toLocaleString()}</td><td class="px-4 py-2 text-xs text-gray-500">ì‹¤ì  Ã— ê³µì œìœ¨</td></tr>`;
                        tableHtml += `<tr class="border-b border-gray-200"><td class="pl-8 py-2">${company} ê´€ë¦¬ìT/O</td><td class="px-4 py-2 text-right text-red-600">${Math.round(d.dedManagerTO).toLocaleString()}</td><td class="px-4 py-2 text-xs text-gray-500">ì‹¤ì  Ã— ê³µì œìœ¨</td></tr>`;
                        tableHtml += `<tr class="border-b border-gray-200"><td class="pl-8 py-2">${company} ìµì›”_ê´€ë¦¬ìíŠ¹ë³„ì‹œì±…</td><td class="px-4 py-2 text-right text-red-600">${Math.round(d.dedManagerSpecialNextMonth).toLocaleString()}</td><td class="px-4 py-2 text-xs text-gray-500">ì‹¤ì  Ã— ì‹œì±…ë¥ </td></tr>`;
                        tableHtml += `<tr class="border-b border-gray-200"><td class="pl-8 py-2">${company} 13íšŒ_ê´€ë¦¬ìíŠ¹ë³„ì‹œì±…</td><td class="px-4 py-2 text-right text-red-600">${Math.round(d.dedManagerSpecial13th).toLocaleString()}</td><td class="px-4 py-2 text-xs text-gray-500">ì‹¤ì  Ã— ì‹œì±…ë¥  Ã— ìœ ì§€ìœ¨</td></tr>`;
                    }
                }
                tableHtml += `<tr class="border-b border-gray-200"><td class="pl-8 py-2">4êµ¬ê°„ ì´ˆê³¼ë‹¬ì„± ì‹œìƒê¸ˆ</td><td class="px-4 py-2 text-right text-red-600">${Math.round(totalDetails.totalTierCashBonus).toLocaleString()}</td><td class="px-4 py-2 text-xs text-gray-500">ë‹¬ì„±ìë³„ ì¶”ê°€ì‹œìƒê¸ˆ í•©ì‚°</td></tr>`;
                tableHtml += `<tr class="border-b border-gray-200"><td class="pl-8 py-2">ë¯¸ë‹¬ì„±ì íŠ¹ë³„ ì‹œìƒê¸ˆ</td><td class="px-4 py-2 text-right text-red-600">${Math.round(totalDetails.totalMonthlyNonAchieverBonus).toLocaleString()}</td><td class="px-4 py-2 text-xs text-gray-500">ë¯¸ë‹¬ì„±ì 3ê°œì›” í•©ì‚° ì‹¤ì  êµ¬ê°„ë³„ ì‹œìƒ í•©ì‚°</td></tr>`;
                tableHtml += `<tr class="border-b border-gray-200 bg-gray-100"><td class="px-4 py-2 font-bold">ì´ì§€ì¶œ í•©ê³„</td><td class="px-4 py-2 text-right font-bold text-red-600">${Math.round(totalDetails.totalDeduction).toLocaleString()}</td><td></td></tr>`;
                tableHtml += `<tr class="bg-gray-200"><td class="px-4 py-2 font-bold text-lg text-cyan-700">ìµœì¢… ì˜ˆìƒ ìˆ˜ìµ</td><td class="px-4 py-2 text-right font-bold text-lg text-cyan-700">${Math.round(totalDetails.finalIncome).toLocaleString()}</td><td>ì´ìˆ˜ì… - ì´ì§€ì¶œ</td></tr>`;
                tableHtml += '</tbody></table></div>';
                modalBody.innerHTML = tableHtml;
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('opacity-100'), 10);
            }
        }

        function printReport() {
            if(Object.keys(scenarioResultsData).length === 0) return;

            const printArea = document.getElementById('print-area');
            printArea.innerHTML = ''; // Clear previous print content
            
            Object.values(scenarioResultsData).forEach(res => {
                const scenarioSection = document.createElement('div');
                scenarioSection.className = 'print-section';

                // --- Page 1 Content ---
                let page1Html = '<div>';

                // Print Header with logos and title
                page1Html += `
                    <div style="position: relative; width: 100%; text-align: center; margin-bottom: 10mm;">
                        <img src="https://github.com/incarmarketing/bali-vote-project/blob/main/logo2.png?raw=true" alt="íšŒì‚¬ ë¡œê³ " style="position: absolute; left: 0; top: -20px; height: 70px; width: 70px; object-fit: contain;" onerror="this.onerror=null;this.src='https://placehold.co/70x70/cccccc/000000?text=Logo';">
                        <div style="margin: 0 auto; padding-top: 0;"> 
                            <h2 style="font-size: 1.2rem; font-weight: bold; color: #000000; margin-bottom: 0.2rem;">ISF ìˆ˜ì… ì‹œë®¬ë ˆì´ì…˜ ë³´ê³ ì„œ (ì‹œë‚˜ë¦¬ì˜¤ ${res.id}, ì„±ì¥ë¥  ${res.growthRate}%)</h2>
                            <p style="font-size: 0.8rem; color: #555555;">ì‹¤ì ê³¼ ìˆ˜ì…ì¡°ê±´ ë°ì´í„° ë§¤ì¹­ì„ í†µí•´ ì •í™•í•œ ì˜ˆìƒ ìˆ˜ì…ì„ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
                        </div>
                        <img src="https://github.com/incarmarketing/bali-vote-project/blob/main/logo3.png?raw=true" alt="ì½”ìŠ¤ë‹¥ ë¡œê³ " style="position: absolute; right: 0; top: -20px; height: 70px; width: 70px; object-fit: contain;" onerror="this.onerror=null;this.src='https://placehold.co/70x70/cccccc/000000?text=KOSDAQ';">
                    </div>
                `;
                
                // --- New Consolidated Achievement Table ---
                const attendingFA = Math.round(res.achievers.length * (res.tripAttendanceRate / 100));
                const nonAttendingFA = res.achievers.length - attendingFA;
                const nonAttendingCompanion = Math.max(0, res.totalCompanions - res.attendingCompanions);

                const achievementTitle = res.excludeDirectFamily ? 'ë‹¬ì„±í˜„í™© (ë‹¤ì´ë ‰íŠ¸ ì œì™¸)' : 'ë‹¬ì„± í˜„í™©';
                page1Html += `<h3 class="print-title" style="margin-top: 0.1rem;">${achievementTitle}</h3>
                    <table class="print-table">
                        <tbody>
                            <tr>
                                <td><strong>ì´ ë‹¬ì„±ì¸ì›</strong></td><td class="text-right">${res.achievers.length.toLocaleString()}ëª…</td>
                                <td><strong>ì´ ë™ë°˜ì¸ì›</strong></td><td class="text-right">${res.totalCompanions.toLocaleString()}ëª…</td>
                            </tr>
                            <tr>
                                <td><strong>ì—¬í–‰ ì°¸ì„ì¸ì› (FA)</strong></td><td class="text-right">${attendingFA.toLocaleString()}ëª…</td>
                                <td><strong>ì—¬í–‰ ì°¸ì„ì¸ì› (ë™ë°˜)</strong></td><td class="text-right">${res.attendingCompanions.toLocaleString()}ëª…</td>
                            </tr>
                             <tr>
                                <td><strong>ë¹„ì°¸ì„ ì¸ì› (FA)</strong></td><td class="text-right">${nonAttendingFA.toLocaleString()}ëª…</td>
                                <td><strong>ë¹„ì°¸ì„ ì¸ì› (ë™ë°˜)</strong></td><td class="text-right">${nonAttendingCompanion.toLocaleString()}ëª…</td>
                            </tr>
                            <tr><td colspan="4" class="print-row-header" style="background-color: #f1f5f9; font-weight: bold;">êµ¬ê°„ë³„ ë‹¬ì„± í˜„í™©</td></tr>
                            <tr><td><strong>1êµ¬ê°„</strong></td><td class="text-right">${res.tierCounts['1êµ¬ê°„'] || 0}ëª…</td><td><strong>2êµ¬ê°„</strong></td><td class="text-right">${res.tierCounts['2êµ¬ê°„'] || 0}ëª…</td></tr>
                            <tr><td><strong>3êµ¬ê°„</strong></td><td class="text-right">${res.tierCounts['3êµ¬ê°„'] || 0}ëª…</td><td><strong>4êµ¬ê°„</strong></td><td class="text-right">${res.tierCounts['4êµ¬ê°„'] || 0}ëª…</td></tr>
                            <tr><td><strong>600ë§Œ ì´ˆê³¼</strong></td><td class="text-right">${res.tierCounts['4êµ¬ê°„ ì´ˆê³¼(600ë§Œ)'] || 0}ëª…</td><td><strong>800ë§Œ ì´ˆê³¼</strong></td><td class="text-right">${res.tierCounts['4êµ¬ê°„ ì´ˆê³¼(800ë§Œ)'] || 0}ëª…</td></tr>
                            <tr><td><strong>1000ë§Œ ì´ˆê³¼</strong></td><td class="text-right">${res.tierCounts['4êµ¬ê°„ ì´ˆê³¼(1000ë§Œ)'] || 0}ëª…</td><td colspan="2"></td></tr>
                            <tr><td colspan="4" class="print-row-header" style="background-color: #f1f5f9; font-weight: bold;">ë¯¸ë‹¬ì„±ì íŠ¹ë³„ ì‹œìƒ í˜„í™©</td></tr>
                            <tr><td><strong>40ë§Œ ~ 80ë§Œ</strong></td><td class="text-right">${res.nonAchieverCounts['40ë§Œì  ì‹œìƒ'] || 0}ëª…</td><td><strong>80ë§Œ ~ 130ë§Œ</strong></td><td class="text-right">${res.nonAchieverCounts['80ë§Œì  ì‹œìƒ'] || 0}ëª…</td></tr>
                        </tbody>
                    </table>`;
                // --- END: Consolidated Achievement Table ---

                // --- START: Detailed Income/Expense Table ---
                let detailsTableHtml = `<h3 class="print-title"><span>ì˜ˆìƒ ìˆ˜ì… ë¶„ì„</span><span style="font-size: 8pt; font-weight: normal;">(ë‹¨ìœ„ : ì›)</span></h3>`;
                
                const totalDetails = res.incomeDetails;
                const companyDetails = res.incomeDetailsByCompany;
                const lifeDetails = res.incomeDetails.lifeInsuranceRevenueDetails;

                let total_life_revenue = 0;
                let total_nonlife_revenue = 0;
                const total_nonattendee_income = totalDetails.netNonAttendeeFAIncome + totalDetails.companionNetIncome;
                let total_isf_travel_manager_expense = 0;
                let total_commission_etc_expense = 0;
                const total_achievement_bonus = totalDetails.totalTierCashBonus + totalDetails.totalMonthlyNonAchieverBonus;
                
                
                let nonLifeIncomeHtml = '<div><table class="print-table"><thead><tr><th colspan="2">[ì†í•´ë³´í—˜] ì´ìˆ˜ì…</th></tr></thead><tbody>';
                if (companyDetails && Object.keys(companyDetails).length > 0) {
                    const sortedNonLifeCompanies = Object.entries(companyDetails).sort(([, a], [, b]) => b.totalRevenue - a.totalRevenue);
                    for (const [company, details] of sortedNonLifeCompanies) {
                        nonLifeIncomeHtml += `<tr><td>&nbsp;&nbsp;${company}</td><td class="text-right">${Math.round(details.totalRevenue).toLocaleString()}</td></tr>`;
                        total_nonlife_revenue += details.totalRevenue;
                        const d = details.details;
                        total_isf_travel_manager_expense += (d.dedIsfTravel || 0) + (d.dedTravelExpense || 0) + (d.dedManagerTO || 0) + (d.dedManagerSpecialNextMonth || 0) + (d.dedManagerSpecial13th || 0);
                        total_commission_etc_expense += (d.dedCommission || 0) + (d.dedOther || 0) + (d.dedLoss || 0);
                    }
                }
                nonLifeIncomeHtml += `<tr style="font-weight:bold; background-color: #e3f2fd;"><td>&nbsp;&nbsp;ì†í•´ë³´í—˜ ì†Œê³„</td><td class="text-right">${Math.round(total_nonlife_revenue).toLocaleString()}</td></tr>`;
                
                const isf_expense_source = total_isf_travel_manager_expense + total_achievement_bonus;
                const finalSummaryTableHtml = `<table class="print-table" style="margin-top: 10px;"><tbody>
                    <tr><td colspan="2" style="background-color: #e0f2fe; font-weight:bold;">ì´ìˆ˜ì… (ê³µí†µ ë° í•©ê³„)</td></tr>
                    <tr><td>&nbsp;&nbsp;ì†ìƒë³´ ì´ìˆ˜ì…</td><td class="text-right">${Math.round(total_nonlife_revenue + total_life_revenue).toLocaleString()}</td></tr>
                    <tr><td>&nbsp;&nbsp;ë¹„ì°¸ì„ì ì°¨ìµ</td><td class="text-right">${Math.round(total_nonattendee_income).toLocaleString()}</td></tr>
                    <tr style="background-color: #e0f2fe; font-weight:bold;"><td>ì´ìˆ˜ì… í•©ê³„</td><td class="text-right">${Math.round(totalDetails.totalRevenue).toLocaleString()}</td></tr>
                    <tr><td colspan="2" style="background-color: #ffebee; font-weight:bold;">ì´ì§€ì¶œ (-)</td></tr>
                    <tr><td>&nbsp;&nbsp;ISF ì‚¬ìš©ì¬ì›</td><td class="text-right">${Math.round(isf_expense_source).toLocaleString()}</td></tr>
                    <tr><td>&nbsp;&nbsp;ìˆ˜ìˆ˜ë£Œ/ê¸°íƒ€ ê³µì œ</td><td class="text-right">${Math.round(total_commission_etc_expense).toLocaleString()}</td></tr>
                    <tr style="background-color: #ffebee; font-weight:bold;"><td>ì´ì§€ì¶œ í•©ê³„</td><td class="text-right">${Math.round(totalDetails.totalDeduction).toLocaleString()}</td></tr>
                    <tr><td style="background-color: #e8f5e9; font-weight:bold;">ìµœì¢… ì˜ˆìƒ ìˆ˜ìµ</td><td class="text-right" style="background-color: #e8f5e9; font-weight:bold;">${Math.round(totalDetails.finalIncome).toLocaleString()}</td></tr>
                </tbody></table>`;

                nonLifeIncomeHtml += '</tbody></table>' + finalSummaryTableHtml + '</div>';

                let lifeIncomeHtml = '<div><table class="print-table"><thead><tr><th colspan="2">[ìƒëª…ë³´í—˜] ì´ìˆ˜ì…</th></tr></thead><tbody>';
                if (lifeDetails && Object.keys(lifeDetails).length > 0) {
                    const sortedLifeCompanies = Object.entries(lifeDetails).sort(([, a], [, b]) => b.total - a.total);
                    for (const [company, details] of sortedLifeCompanies) {
                        lifeIncomeHtml += `<tr><td>&nbsp;&nbsp;${company}</td><td class="text-right">${Math.round(details.total).toLocaleString()}</td></tr>`;
                        total_life_revenue += details.total;
                    }
                }
                lifeIncomeHtml += `<tr style="font-weight:bold; background-color: #e3f2fd;"><td>&nbsp;&nbsp;ìƒëª…ë³´í—˜ ì†Œê³„</td><td class="text-right">${Math.round(total_life_revenue).toLocaleString()}</td></tr>`;
                lifeIncomeHtml += '</tbody></table></div>';
                
                detailsTableHtml += '<div class="print-grid">' + nonLifeIncomeHtml + lifeIncomeHtml + '</div>';
                
                page1Html += detailsTableHtml + '</div>';
                // --- END: Detailed Income/Expense Table ---

                // --- START: Performance Table (Page 2) ---
                const companyToTypeMap = res.companyToTypeMap;
                const perfByCompany = res.monthlyPerformanceByCompany;
                const lifeCompanies = [];
                const nonLifeCompanies = [];

                for (const company in perfByCompany) {
                    const perf = perfByCompany[company];
                    const total = perf.june + perf.july + perf.august;
                    const data = { name: company, june: perf.june, july: perf.july, august: perf.august, total: total };
                    if (companyToTypeMap[company] === 'ìƒëª…ë³´í—˜') {
                        lifeCompanies.push(data);
                    } else {
                        nonLifeCompanies.push(data);
                    }
                }

                lifeCompanies.sort((a, b) => b.total - a.total);
                nonLifeCompanies.sort((a, b) => b.total - a.total);

                let monthlyPerfTable = `<div style="page-break-before: always;"><h3 class="print-title"><span>ë³´í—˜ì‚¬ë³„ ì›”ë³„/í•©ì‚° ì˜ˆìƒ ì‹¤ì </span><span style="font-size: 8pt; font-weight: normal;">(ë‹¨ìœ„ : ì›)</span></h3>
                    <table class="print-table">
                        <thead><tr><th>ë³´í—˜ì‚¬ êµ¬ë¶„/ë³´í—˜ì‚¬ëª…</th><th class="text-right">6ì›”</th><th class="text-right">7ì›”</th><th class="text-right">8ì›”</th><th class="text-right">í•©ê³„</th></tr></thead>
                        <tbody>`;

                const generatePerfRows = (companies, typeName) => {
                    let html = `<tr><td colspan="5" style="background-color: #f1f5f9; font-weight: bold;">[${typeName}]</td></tr>`;
                    let juneSubTotal = 0, julySubTotal = 0, augustSubTotal = 0, totalSubTotal = 0;
                    companies.forEach(c => {
                        html += `<tr><td>&nbsp;&nbsp;${c.name}</td><td class="text-right">${Math.round(c.june).toLocaleString()}</td><td class="text-right">${Math.round(c.july).toLocaleString()}</td><td class="text-right">${Math.round(c.august).toLocaleString()}</td><td class="text-right">${Math.round(c.total).toLocaleString()}</td></tr>`;
                        juneSubTotal += c.june; julySubTotal += c.july; augustSubTotal += c.august; totalSubTotal += c.total;
                    });
                    html += `<tr style="background-color: #e2e8f0; font-weight: bold;"><td>&nbsp;&nbsp;${typeName} ì†Œê³„</td><td class="text-right">${Math.round(juneSubTotal).toLocaleString()}</td><td class="text-right">${Math.round(julySubTotal).toLocaleString()}</td><td class="text-right">${Math.round(augustSubTotal).toLocaleString()}</td><td class="text-right">${Math.round(totalSubTotal).toLocaleString()}</td></tr>`;
                    return { html, totals: { june: juneSubTotal, july: julySubTotal, august: augustSubTotal, total: totalSubTotal } };
                };
                
                const lifePerf = generatePerfRows(lifeCompanies, 'ìƒëª…ë³´í—˜');
                const nonLifePerf = generatePerfRows(nonLifeCompanies, 'ì†í•´ë³´í—˜');
                
                monthlyPerfTable += nonLifePerf.html;
                monthlyPerfTable += lifePerf.html;

                const grandTotal = {
                    june: lifePerf.totals.june + nonLifePerf.totals.june,
                    july: lifePerf.totals.july + nonLifePerf.totals.july,
                    august: lifePerf.totals.august + nonLifePerf.totals.august,
                    total: lifePerf.totals.total + nonLifePerf.totals.total
                };

                monthlyPerfTable += `<tr style="background-color: #cbd5e1; font-weight: bold;">
                    <td>ì´ê³„</td>
                    <td class="text-right">${Math.round(grandTotal.june).toLocaleString()}</td>
                    <td class="text-right">${Math.round(grandTotal.july).toLocaleString()}</td>
                    <td class="text-right">${Math.round(grandTotal.august).toLocaleString()}</td>
                    <td class="text-right">${Math.round(grandTotal.total).toLocaleString()}</td>
                </tr></tbody></table></div>`;
                // --- END: Performance Table ---

                scenarioSection.innerHTML = page1Html + monthlyPerfTable;
                printArea.appendChild(scenarioSection);
            });
            
            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');
        }
    </script>
</body>
</html>